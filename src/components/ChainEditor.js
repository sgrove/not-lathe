// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Card from "../Card.js";
import * as Uuid from "uuid";
import * as Acorn from "../bindings/Acorn.js";
import * as Chain from "../Chain.js";
import * as Comps from "./Comps.js";
import * as Curry from "bs-platform/lib/es6/curry.mjs";
import * as Debug from "../Debug.js";
import * as Icons from "../Icons.js";
import * as Utils from "../bindings/Utils.js";
import * as Acorn$1 from "acorn";
import * as React from "react";
import * as $$String from "bs-platform/lib/es6/string.mjs";
import * as Js_dict from "bs-platform/lib/es6/js_dict.mjs";
import * as Graphql from "graphql";
import * as Caml_obj from "bs-platform/lib/es6/caml_obj.mjs";
import * as Prettier from "prettier";
import * as GraphQLJs from "../bindings/GraphQLJs.js";
import * as Inspector from "./Inspector.js";
import * as Belt_Array from "bs-platform/lib/es6/belt_Array.mjs";
import * as Caml_array from "bs-platform/lib/es6/caml_array.mjs";
import * as OneGraphRe from "../OneGraphRe.js";
import * as TypeScript from "../bindings/TypeScript.js";
import * as Typescript from "typescript";
import Typescript$1 from "typescript";
import * as Belt_Option from "bs-platform/lib/es6/belt_Option.mjs";
import * as BlockEditor from "./BlockEditor.js";
import * as Caml_option from "bs-platform/lib/es6/caml_option.mjs";
import * as GraphQLUtils from "../bindings/GraphQLUtils.js";
import * as OneGraphAuth from "../bindings/OneGraphAuth.js";
import * as BsReactMonaco from "../bindings/BsReactMonaco.js";
import * as Belt_SetString from "bs-platform/lib/es6/belt_SetString.mjs";
import * as Belt_SortArray from "bs-platform/lib/es6/belt_SortArray.mjs";
import FragmentNodeJs from "./FragmentNode.js";
import * as ConnectionContext from "./ConnectionContext.js";
import * as Caml_js_exceptions from "bs-platform/lib/es6/caml_js_exceptions.mjs";
import * as ReactFlowRenderer from "react-flow-renderer";
import ReactFlowRenderer$1 from "react-flow-renderer";
import ParserBabel from "prettier/parser-babel";

var SimpleTooltip = {};

var make = FragmentNodeJs;

var FragmentNodeComponent = {
  make: make
};

function makeBlankBlock(param) {
  return {
          id: Uuid.v4(),
          title: "Untitled",
          description: "TODO",
          body: "query Untitled { __typename }",
          kind: /* Query */0,
          contributedBy: undefined,
          services: []
        };
}

function compileChain(schema, chain) {
  try {
    var compiled = Chain.compileAsObj(chain);
    var parsedOperationDoc = Graphql.parse(compiled.operationDoc);
    var mockedVariables = GraphQLJs.Mock.mockOperationDocVariables(schema, parsedOperationDoc);
    return {
            compiled: compiled,
            variables: mockedVariables
          };
  }
  catch (_ex){
    return ;
  }
}

function ChainEditor$BlockSearch(Props) {
  var onAdd = Props.onAdd;
  var onInspect = Props.onInspect;
  var blocks = Props.blocks;
  var onCreate = Props.onCreate;
  var match = React.useState(function () {
        return {
                search: undefined,
                results: blocks.slice(0).sort(function (a, b) {
                      return $$String.compare(a.title.toLocaleLowerCase(), b.title.toLocaleLowerCase());
                    })
              };
      });
  var setState = match[1];
  var state = match[0];
  var searchBlocks = function (blocks, term) {
    return Belt_Array.keep(blocks, (function (block) {
                    var titleMatch = Belt_Option.isSome(Caml_option.null_to_opt(block.title.match(new RegExp(term, "ig"))));
                    var servicesMatch = Belt_Array.some(block.services, (function (service) {
                            return Belt_Option.isSome(Caml_option.null_to_opt(service.match(new RegExp(term, "ig"))));
                          }));
                    if (titleMatch) {
                      return true;
                    } else {
                      return servicesMatch;
                    }
                  })).sort(function (a, b) {
                return $$String.compare(a.title.toLocaleLowerCase(), b.title.toLocaleLowerCase());
              });
  };
  React.useEffect((function () {
          var term = state.search;
          if (term !== undefined) {
            var results = searchBlocks(blocks, term);
            Curry._1(setState, (function (oldState) {
                    return {
                            search: oldState.search,
                            results: results
                          };
                  }));
          }
          
        }), [blocks.length]);
  var match$1 = state.search;
  return React.createElement("div", {
              className: "flex w-full m-0 max-h-full block",
              style: {
                backgroundColor: "#1D1F22"
              }
            }, React.createElement("div", {
                  className: "w-full max-h-full"
                }, React.createElement(Comps.Header.make, {
                      children: "Block Library"
                    }), React.createElement("div", {
                      className: "shadow-md rounded-lg px-3 py-2 h-full overflow-y-hidden"
                    }, React.createElement("div", {
                          className: "flex items-center  rounded-md inline-block",
                          style: {
                            backgroundColor: "#282B30"
                          }
                        }, React.createElement("div", {
                              className: "pl-2"
                            }, React.createElement(Icons.Search.make, {
                                  color: Comps.colors["gray-4"]
                                })), React.createElement("input", {
                              className: "w-full rounded-md text-gray-700 leading-tight focus:outline-none py-2 px-2 border-0",
                              id: "search",
                              style: {
                                backgroundColor: "#282B30"
                              },
                              spellCheck: false,
                              placeholder: "Search for blocks",
                              type: "text",
                              onChange: (function ($$event) {
                                  var query = $$event.target.value;
                                  var search = query === "" ? undefined : query;
                                  var results = search !== undefined ? searchBlocks(blocks, search) : blocks;
                                  return Curry._1(setState, (function (_oldState) {
                                                return {
                                                        search: search,
                                                        results: results
                                                      };
                                              }));
                                })
                            }), React.createElement("div", {
                              className: "flex items-center rounded-md inline "
                            }, React.createElement("button", {
                                  className: "p-2 hover:bg-blue-200 rounded-md",
                                  onClick: (function (param) {
                                      return Curry._1(onCreate, undefined);
                                    })
                                }, "+"))), React.createElement("div", {
                          className: "py-3 text-sm h-full overflow-y-scroll"
                        }, Belt_Array.map((
                                  match$1 !== undefined ? state.results : blocks
                                ).slice(0).sort(function (a, b) {
                                  return $$String.compare(a.title.toLocaleLowerCase(), b.title.toLocaleLowerCase());
                                }), (function (block) {
                                var match = block.kind;
                                var color;
                                switch (match) {
                                  case /* Query */0 :
                                      color = "1BBE83";
                                      break;
                                  case /* Mutation */1 :
                                      color = "B20D5D";
                                      break;
                                  case /* Subscription */2 :
                                  case /* Fragment */3 :
                                      color = "F2C94C";
                                      break;
                                  
                                }
                                return React.createElement("div", {
                                            key: block.title,
                                            className: "flex justify-start cursor-grab text-gray-700 items-center hover:text-blue-400 rounded-md px-2 my-2",
                                            style: {
                                              backgroundColor: "#282C31"
                                            },
                                            onClick: (function (param) {
                                                return Curry._1(onInspect, block);
                                              }),
                                            onDoubleClick: (function (param) {
                                                return Curry._1(onAdd, block);
                                              })
                                          }, React.createElement("div", {
                                                style: {
                                                  background: "radial-gradient(ellipse at center, #" + color + " 0%, #" + color + " 30%, transparent 30%)",
                                                  backgroundRepeat: "repeat-x",
                                                  height: "10px",
                                                  width: "10px"
                                                }
                                              }), React.createElement("div", {
                                                className: "flex-grow font-medium px-2 py-2 truncate",
                                                style: {
                                                  color: "#F2F2F2"
                                                }
                                              }, block.title), React.createElement("div", {
                                                className: "px-2  rounded-r-md py-2",
                                                style: {
                                                  backgroundColor: "#E0E0E0",
                                                  minWidth: "40px"
                                                }
                                              }, Belt_Array.keepMap(block.services, (function (service) {
                                                      return Belt_Option.map(Utils.serviceImageUrl(undefined, undefined, service), (function (param) {
                                                                    var friendlyServiceName = param[1];
                                                                    return React.createElement("img", {
                                                                                key: friendlyServiceName,
                                                                                className: "rounded-full",
                                                                                style: {
                                                                                  pointerEvents: "none"
                                                                                },
                                                                                title: friendlyServiceName,
                                                                                alt: friendlyServiceName,
                                                                                src: param[0]
                                                                              });
                                                                  }));
                                                    }))));
                              }))))));
}

var BlockSearch = {
  make: ChainEditor$BlockSearch
};

var context = React.createContext(undefined);

var provider = context.Provider;

function ChainEditor$InspectedContextProvider(Props) {
  var value = Props.value;
  var children = Props.children;
  return React.createElement(provider, {
              value: value,
              children: children
            });
}

var InspectedContextProvider = {
  context: context,
  provider: provider,
  make: ChainEditor$InspectedContextProvider
};

function ChainEditor$NodeLabel(Props) {
  var request = Props.request;
  var block = Props.block;
  var onEditBlock = Props.onEditBlock;
  var onDragStart = Props.onDragStart;
  var onPotentialVariableSourceConnect = Props.onPotentialVariableSourceConnect;
  ((console.log("NL Args: ", arguments)));
  var services = Belt_Array.keepMap(block.services, (function (service) {
          return Belt_Option.map(Utils.serviceImageUrl(undefined, undefined, service), (function (param) {
                        var friendlyServiceName = param[1];
                        return React.createElement("img", {
                                    key: friendlyServiceName,
                                    className: "shadow-lg rounded-full",
                                    style: {
                                      pointerEvents: "none"
                                    },
                                    title: friendlyServiceName,
                                    alt: friendlyServiceName,
                                    height: "16px",
                                    src: param[0],
                                    width: "16px"
                                  });
                      }));
        }));
  var connectionDrag = React.useContext(ConnectionContext.context);
  var domRef = React.useRef(null);
  var className;
  var exit = 0;
  if (typeof connectionDrag === "number") {
    className = "";
  } else {
    switch (connectionDrag.TAG | 0) {
      case /* StartedTarget */1 :
          className = "";
          break;
      case /* StartedSource */0 :
      case /* Completed */2 :
          exit = 1;
          break;
      
    }
  }
  if (exit === 1) {
    className = Caml_obj.caml_equal(connectionDrag.sourceRequest, request) ? "bg-green-700" : "";
  }
  return React.createElement("div", {
              ref: domRef,
              className: "flex align-middle items-center min-w-max flex-col " + className,
              onContextMenu: (function ($$event) {
                  
                }),
              onMouseDown: (function ($$event) {
                  if ($$event.altKey) {
                    $$event.preventDefault();
                    $$event.stopPropagation();
                    return Belt_Option.forEach(request, (function (request) {
                                  return Curry._3(onDragStart, $$event, request, domRef.current);
                                }));
                  }
                  
                }),
              onMouseUp: (function ($$event) {
                  return Belt_Option.forEach(request, (function (sourceRequest) {
                                if (typeof connectionDrag === "number") {
                                  return ;
                                }
                                if (connectionDrag.TAG !== /* StartedTarget */1) {
                                  return ;
                                }
                                var clientX = $$event.clientX;
                                var clientY = $$event.clientY;
                                var mouseClientPosition = [
                                  clientX,
                                  clientY
                                ];
                                return Curry._1(onPotentialVariableSourceConnect, {
                                            TAG: 2,
                                            sourceRequest: sourceRequest,
                                            sourceDom: connectionDrag.sourceDom,
                                            target: connectionDrag.target,
                                            windowPosition: mouseClientPosition,
                                            [Symbol.for("name")]: "Completed"
                                          });
                              }));
                })
            }, React.createElement("div", {
                  className: "flex flex-row items-center justify-end font-mono"
                }, React.createElement("div", {
                      className: "m-2"
                    }, services), React.createElement("div", {
                      className: "flex-1 inline-block "
                    }, block.title), React.createElement("div", {
                      className: "p-2 hover:shadow-lg rounded-md hover:border-gray-300 cursor-pointer m-0",
                      onClick: (function ($$event) {
                          $$event.preventDefault();
                          return Curry._1(onEditBlock, block);
                        })
                    }, React.createElement(Icons.GraphQL.make, {
                          color: "rgb(181,181,181)",
                          width: "16px",
                          height: "16px"
                        }))));
}

var NodeLabel = {
  make: ChainEditor$NodeLabel
};

function ChainEditor$OperationNodeComponent(Props) {
  var data = Props.data;
  console.log("OperationNode: ", data);
  ((console.log("ON Args: ", arguments)));
  Debug.assignToWindowForDeveloperDebug("nodeData", data);
  return React.createElement("div", {
              className: "rounded-sm node-label p-2"
            }, React.createElement("div", undefined, data.label));
}

var OperationNodeComponent = {
  make: ChainEditor$OperationNodeComponent
};

function emptyGraphLevel(level) {
  return {
          nodeCount: 0,
          width: 0,
          nodes: [],
          level: level
        };
}

function diagramFromChain(chain, onEditBlock, onDragStart, schema, onPotentialVariableSourceConnect, param) {
  var nodeStyle = {
    width: "unset"
  };
  var fragmentNodes = Belt_Array.mapWithIndex(Belt_SortArray.stableSortBy(Belt_Array.keep(chain.blocks, (function (block) {
                  var match = block.kind;
                  return match >= 3;
                })), (function (a, b) {
              return a.title.localeCompare(b.title) | 0;
            })), (function (idx, block) {
          return {
                  id: block.id.toString(),
                  type: "fragment",
                  data: {
                    label: React.createElement(ChainEditor$NodeLabel, {
                          request: undefined,
                          block: block,
                          onEditBlock: onEditBlock,
                          onDragStart: onDragStart,
                          schema: schema,
                          onPotentialVariableSourceConnect: onPotentialVariableSourceConnect
                        })
                  },
                  position: {
                    x: -250,
                    y: 50 * idx
                  },
                  draggable: false,
                  connectable: false,
                  className: "node-label",
                  style: nodeStyle
                };
        }));
  var match = fragmentNodes.length;
  var fragmentLabelNode = match !== 0 ? [{
        id: "fragmentColumnLabel",
        type: "fragment",
        data: {
          label: "Reusable Fragments"
        },
        position: {
          x: -250,
          y: -50
        },
        draggable: false,
        connectable: false,
        style: {
          width: "unset"
        }
      }] : [];
  var operationBlocks = Belt_Array.keep(chain.blocks, (function (block) {
          var match = block.kind;
          return match < 3;
        }));
  var levels = {};
  var graphLevels = {};
  var findReqLevel = function (request) {
    var level = Js_dict.get(levels, request.id);
    if (level !== undefined) {
      return level;
    }
    var highestDependency = Belt_Array.reduce(request.dependencyRequestIds, -2, (function (level, nextId) {
            return Belt_Option.getWithDefault(Belt_Option.flatMap(Belt_Array.getBy(chain.requests, (function (depReq) {
                                  return depReq.id === nextId;
                                })), (function (depReq) {
                              if (depReq.id === request.id) {
                                return ;
                              }
                              var dependencyLevel = findReqLevel(depReq);
                              levels[nextId] = dependencyLevel;
                              return Math.max(level, dependencyLevel);
                            })), level);
          }));
    var requestLevel = highestDependency + 1 | 0;
    var nodeTitleWidth = request.operation.title.length * 7.2;
    var requestWidth = nodeTitleWidth + 105 + 10;
    var graphLevel = Belt_Option.getWithDefault(Js_dict.get(graphLevels, String(requestLevel)), emptyGraphLevel(requestLevel));
    var graphNode_left = graphLevel.width;
    var graphNode = {
      request: request,
      level: requestLevel,
      left: graphNode_left
    };
    var newGraphLevel_nodeCount = graphLevel.nodeCount + 1 | 0;
    var newGraphLevel_width = graphLevel.width + requestWidth;
    var newGraphLevel_nodes = Belt_Array.concat(graphLevel.nodes, [graphNode]);
    var newGraphLevel_level = graphLevel.level;
    var newGraphLevel = {
      nodeCount: newGraphLevel_nodeCount,
      width: newGraphLevel_width,
      nodes: newGraphLevel_nodes,
      level: newGraphLevel_level
    };
    graphLevels[String(requestLevel)] = newGraphLevel;
    return requestLevel;
  };
  Belt_Array.forEach(operationBlocks, (function (block) {
          var req = Belt_Array.getBy(chain.requests, (function (req) {
                  return req.id === block.title;
                }));
          return Belt_Option.forEach(req, (function (req) {
                        var level = findReqLevel(req);
                        levels[req.id] = level;
                        
                      }));
        }));
  var totalWidth = Belt_Array.reduce(Js_dict.values(graphLevels), 0, (function (highest, next) {
          if (next.width > highest) {
            return next.width;
          } else {
            return highest;
          }
        }));
  var operationNodes = Belt_Array.concatMany(Belt_Array.map(Belt_SortArray.stableSortBy(Js_dict.values(graphLevels), (function (a, b) {
                  return a.level - b.level | 0;
                })), (function (graphLevel) {
              return Belt_Array.map(graphLevel.nodes, (function (node) {
                            var req = node.request;
                            var block = req.operation;
                            var variables = Card.getFirstVariables(block);
                            var hasVariables = variables.length !== 0;
                            var typ = hasVariables ? "default" : "input";
                            var level = node.level;
                            var halfWidth = totalWidth / 2;
                            var furthestLeft = halfWidth - graphLevel.width / 2;
                            var x = 250 + furthestLeft + node.left;
                            return {
                                    id: block.id.toString(),
                                    type: typ,
                                    data: {
                                      label: React.createElement(ChainEditor$NodeLabel, {
                                            request: node.request,
                                            block: block,
                                            onEditBlock: onEditBlock,
                                            onDragStart: onDragStart,
                                            schema: schema,
                                            onPotentialVariableSourceConnect: onPotentialVariableSourceConnect
                                          })
                                    },
                                    position: {
                                      x: x,
                                      y: 100 + (50 + 10.0) * level
                                    },
                                    draggable: true,
                                    connectable: true,
                                    className: "node-label",
                                    style: nodeStyle
                                  };
                          }));
            })));
  var argDepEdges = Belt_Array.concatMany(Belt_Array.map(chain.blocks, (function (block) {
              var req = Belt_Array.getBy(chain.requests, (function (req) {
                      return req.id === block.title;
                    }));
              var target = block.id.toString();
              return Belt_Array.concatMany(Belt_Option.getWithDefault(Belt_Option.map(req, (function (req) {
                                    var ast = Graphql.parse(req.operation.body);
                                    var variables = Belt_Option.getWithDefault(Belt_Option.getExn(Belt_Array.get(ast.definitions, 0)).variableDefinitions, []);
                                    return Belt_Array.map(variables, (function (varDef) {
                                                  var varName = varDef.variable.name.value;
                                                  var argDep = Belt_Option.flatMap(Belt_Array.getBy(req.variableDependencies, (function (argDep) {
                                                              var match = argDep.name === varName;
                                                              var match$1 = argDep.dependency;
                                                              if (!match) {
                                                                return false;
                                                              }
                                                              switch (match$1.TAG | 0) {
                                                                case /* ArgumentDependency */0 :
                                                                    return true;
                                                                case /* Direct */1 :
                                                                case /* GraphQLProbe */2 :
                                                                    return false;
                                                                
                                                              }
                                                            })), (function (argDep) {
                                                          var dep = argDep.dependency;
                                                          switch (dep.TAG | 0) {
                                                            case /* ArgumentDependency */0 :
                                                                return dep._0;
                                                            case /* Direct */1 :
                                                            case /* GraphQLProbe */2 :
                                                                return ;
                                                            
                                                          }
                                                        }));
                                                  if (argDep === undefined) {
                                                    return [];
                                                  }
                                                  var edges = Belt_Array.keepMap(argDep.fromRequestIds, (function (requestId) {
                                                          var requestDependency = Belt_Array.getBy(chain.requests, (function (existingRequest) {
                                                                  return existingRequest.id === requestId;
                                                                }));
                                                          return Belt_Option.map(requestDependency, (function (requestDependency) {
                                                                        var source = requestDependency.operation.id.toString();
                                                                        var id = source + "-" + target;
                                                                        var edge = {
                                                                          id: id,
                                                                          source: source,
                                                                          target: target
                                                                        };
                                                                        return [
                                                                                id,
                                                                                edge
                                                                              ];
                                                                      }));
                                                        }));
                                                  return Belt_Array.reduce(edges, [
                                                                undefined,
                                                                []
                                                              ], (function (param, param$1) {
                                                                  var id = param$1[0];
                                                                  var edges = param[1];
                                                                  var distinct = param[0];
                                                                  if (Belt_SetString.has(distinct, id)) {
                                                                    return [
                                                                            distinct,
                                                                            edges
                                                                          ];
                                                                  } else {
                                                                    return [
                                                                            Belt_SetString.add(distinct, id),
                                                                            Belt_Array.concat(edges, [param$1[1]])
                                                                          ];
                                                                  }
                                                                }))[1];
                                                }));
                                  })), []));
            })));
  var reqEdge = Belt_Array.concatMany(Belt_Array.map(chain.requests, (function (request) {
              var target = request.operation.id.toString();
              return Belt_Array.keepMap(request.dependencyRequestIds, (function (requestId) {
                            var reifiedRequest = Belt_Array.getBy(chain.requests, (function (req) {
                                    return req.id === requestId;
                                  }));
                            return Belt_Option.map(reifiedRequest, (function (requestDependency) {
                                          var source = requestDependency.operation.id.toString();
                                          var id = source + "-" + target;
                                          return {
                                                  id: id,
                                                  source: source,
                                                  target: target
                                                };
                                        }));
                          }));
            })));
  var match$1 = Belt_Array.reduce(Belt_Array.concat(argDepEdges, reqEdge), [
        undefined,
        []
      ], (function (param, edge) {
          var edges = param[1];
          var distinct = param[0];
          if (Belt_SetString.has(distinct, edge.id)) {
            return [
                    distinct,
                    edges
                  ];
          } else {
            return [
                    Belt_SetString.add(distinct, edge.id),
                    Belt_Array.concat(edges, [edge])
                  ];
          }
        }));
  var edges = Belt_Array.map(match$1[1], (function (param) {
          return {
                  id: param.id,
                  source: param.source,
                  target: param.target,
                  style: {
                    stroke: "rgb(78,160,23)",
                    strokeWidth: "2px"
                  },
                  animated: true,
                  type: "step"
                };
        }));
  var nodes = Belt_Array.concat(fragmentNodes, operationNodes);
  var elements = Belt_Array.concatMany([
        nodes,
        edges,
        fragmentLabelNode
      ]);
  return {
          nodes: nodes,
          edges: edges,
          elements: elements
        };
}

var backgroundStyle = {
  backgroundColor: "rgb(60, 60, 60)",
  backgroundImage: "linear-gradient(0deg, transparent 24%, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, 0.05) 75%, rgba(255, 255, 255, 0.05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, 0.05) 75%, rgba(255, 255, 255, 0.05) 76%, transparent 77%, transparent)",
  display: "flex",
  height: "100%",
  backgroundSize: "50px 50px",
  borderRadius: "0px"
};

function requestScriptTypeScriptSignature(request, schema, chain) {
  var chainFragmentsDoc = Belt_Array.keepMap(chain.blocks, (function (block) {
              var match = block.kind;
              if (match >= 3) {
                return block.body;
              }
              
            })).join("\n\n").concat("\n\nfragment INTERNAL_UNUSED on Query { __typename }");
  var chainFragmentDefinitions = GraphQLJs.Mock.gatherFragmentDefinitions({
        operationDoc: chainFragmentsDoc
      });
  var upstreamArgDepRequestIds = Belt_Array.concatMany(Belt_Array.keepMap(request.variableDependencies, (function (varDep) {
              var argDep = varDep.dependency;
              switch (argDep.TAG | 0) {
                case /* ArgumentDependency */0 :
                    return argDep._0.fromRequestIds;
                case /* Direct */1 :
                case /* GraphQLProbe */2 :
                    return ;
                
              }
            })));
  var upstreamRequestDependencyIds = request.dependencyRequestIds;
  var upstreamRequestIds = Utils.distinctStrings(Belt_Array.concat(upstreamArgDepRequestIds, upstreamRequestDependencyIds));
  var dependencyRequests = Belt_Array.keepMap(chain.requests, (function (request) {
          var match = upstreamRequestIds.indexOf(request.id);
          if (match === -1) {
            return ;
          }
          var ast = Graphql.parse(request.operation.body);
          var dependencyRequest = Belt_Array.get(ast.definitions, 0);
          return Belt_Option.map(dependencyRequest, (function (dependencyRequest) {
                        var tsSignature = GraphQLJs.Mock.typeScriptForOperation(schema, dependencyRequest, chainFragmentDefinitions);
                        return [
                                request.id,
                                tsSignature
                              ];
                      }));
        }));
  Belt_Array.reduce(dependencyRequests, {}, (function (acc, param) {
          acc[param[0]] = param[1];
          return acc;
        }));
  var fields = Belt_Array.map(dependencyRequests, (function (param) {
            return "\"" + param[0] + "\": " + param[1];
          })).join(", ");
  var inputType = "{" + fields + "}";
  var inputType$1;
  switch (inputType) {
    case "" :
    case "{}" :
        inputType$1 = "EmptyObject";
        break;
    default:
      inputType$1 = inputType;
  }
  var operationDef = Belt_Array.get(Graphql.parse(request.operation.body).definitions, 0);
  var outputTypeForVariables = Belt_Option.getWithDefault(Belt_Option.map(operationDef, (function (operationDef) {
              var signature = GraphQLJs.Mock.typeScriptSignatureForOperationVariables(Belt_Array.keepMap(request.variableDependencies, (function (varDep) {
                          var argDep = varDep.dependency;
                          switch (argDep.TAG | 0) {
                            case /* ArgumentDependency */0 :
                                return argDep._0.name;
                            case /* Direct */1 :
                            case /* GraphQLProbe */2 :
                                return ;
                            
                          }
                        })), schema, operationDef);
              if (signature === "{}") {
                return "EmptyObject";
              } else {
                return signature;
              }
            })), "// No operation definition for request");
  var names = Chain.requestScriptNames(request);
  var outputType = "export type " + names.returnTypeName + " = " + outputTypeForVariables;
  var inputType$2 = "export type " + names.inputTypeName + " = " + inputType$1;
  return {
          functionFromScriptInputType: inputType$2,
          functionFromScriptOutputType: outputType,
          functionFromScriptName: names.functionName
        };
}

function monacoTypelibForChain(schema, chain) {
  var types = Belt_Array.map(chain.requests, (function (request) {
          return requestScriptTypeScriptSignature(request, schema, chain);
        }));
  var dDotTsDefs = Belt_Array.map(types, (function (typeSigs) {
            return typeSigs.functionFromScriptInputType + "\n" + typeSigs.functionFromScriptOutputType + "\n";
          })).join("\n\n");
  var dDotTs = "type EmptyObject = Record<any, never>\n\n" + dDotTsDefs;
  var names = Belt_Array.map(chain.requests, Chain.requestScriptNames);
  var importedNames = Belt_Array.concatMany(Belt_Array.map(names, (function (param) {
                return [
                        param.inputTypeName,
                        param.returnTypeName
                      ];
              }))).join(", ");
  var importLine = "import { " + importedNames + " } from 'oneGraphStudio';";
  return {
          importLine: importLine,
          dDotTs: dDotTs
        };
}

function ChainEditor$Script(Props) {
  var schema = Props.schema;
  var chain = Props.chain;
  var onChange = Props.onChange;
  var className = Props.className;
  var onMount = Props.onMount;
  var onPotentialScriptSourceConnect = Props.onPotentialScriptSourceConnect;
  var content = chain.script;
  var editor = React.useRef(undefined);
  var monaco = React.useRef(undefined);
  var match = monacoTypelibForChain(schema, chain);
  var types = match.dDotTs;
  var connectionDrag = React.useContext(ConnectionContext.context);
  var connectionDragRef = React.useRef(connectionDrag);
  React.useEffect((function () {
          connectionDragRef.current = connectionDrag;
          
        }), [ConnectionContext.toSimpleString(connectionDrag)]);
  React.useEffect((function () {
          Belt_Option.forEach(editor.current, (function (editor) {
                  var position = editor.getPosition();
                  editor.setValue(content);
                  editor.setPosition(position);
                  
                }));
          
        }), [content]);
  React.useEffect((function () {
          Belt_Option.forEach(monaco.current, (function (monaco) {
                  var match = monacoTypelibForChain(schema, chain);
                  var importLine = match.importLine;
                  BsReactMonaco.TypeScript.addLib(monaco, match.dDotTs, content);
                  var hasImport = Belt_Option.isSome(Caml_option.null_to_opt(chain.script.match(new RegExp("import[\\s\\S.]+from[\\s\\S]+'oneGraphStudio';"))));
                  return Curry._1(onChange, hasImport ? chain.script.replace(new RegExp("import[\\s\\S.]+from[\\s\\S]+'oneGraphStudio';"), importLine) : importLine + "\n\n" + chain.script);
                }));
          
        }), [types]);
  var filename = "file:///main.tsx";
  var tmp = {
    defaultValue: content,
    language: "typescript",
    theme: "vs-dark",
    options: {
      minimap: {
        enabled: false
      }
    },
    onChange: (function (newScript, param) {
        return Curry._1(onChange, newScript);
      }),
    onMount: (function (editorHandle, monacoInstance) {
        Debug.assignToWindowForDeveloperDebug("myEditor", editorHandle);
        Debug.assignToWindowForDeveloperDebug("myMonaco", monacoInstance);
        Debug.assignToWindowForDeveloperDebug("ts", Typescript$1);
        editorHandle.onMouseUp(function (mouseEvent) {
              Debug.assignToWindowForDeveloperDebug("editorMouseEvent", mouseEvent);
              var match = connectionDragRef.current;
              if (typeof match === "number") {
                return ;
              }
              if (match.TAG !== /* StartedSource */0) {
                return ;
              }
              var position = mouseEvent.target.position;
              var lineNumber = position.lineNumber;
              var column = position.column;
              var $$event = mouseEvent.event;
              var mousePositionX = $$event.posx;
              var mousePositionY = $$event.posy;
              var mousePosition = [
                mousePositionX,
                mousePositionY
              ];
              return Curry._4(onPotentialScriptSourceConnect, match.sourceRequest, match.sourceDom, {
                          lineNumber: lineNumber,
                          column: column
                        }, mousePosition);
            });
        BsReactMonaco.TypeScript.addLib(monacoInstance, types, content);
        BsReactMonaco.registerPrettier(monacoInstance);
        var modelOptions = {
          tabSize: 2
        };
        editor.current = Caml_option.some(editorHandle);
        monaco.current = Caml_option.some(monacoInstance);
        editorHandle.getModel(filename).updateOptions(modelOptions);
        return Curry._2(onMount, editorHandle, monacoInstance);
      }),
    path: filename
  };
  if (className !== undefined) {
    tmp.className = Caml_option.valFromOption(className);
  }
  return React.createElement(BsReactMonaco.Editor.make, tmp);
}

var Script = {
  make: ChainEditor$Script
};

function ChainEditor$Modal(Props) {
  var children = Props.children;
  return React.createElement("div", {
              className: "flex items-center justify-center fixed left-0 bottom-0 w-full h-full bg-gray-800 bg-opacity-60",
              style: {
                zIndex: "9999"
              }
            }, React.createElement("div", {
                  className: "bg-white rounded-lg w-4/5 h-4/5"
                }, React.createElement("div", {
                      className: "flex flex-col p-1 h-full"
                    }, React.createElement("div", {
                          className: "flex h-full"
                        }, children))));
}

var Modal = {
  make: ChainEditor$Modal
};

function ChainEditor$ConnectorLine(Props) {
  var source = Props.source;
  var onDragEnd = Props.onDragEnd;
  var invert = Props.invert;
  var match = React.useState(function () {
        var rect = source.getBoundingClientRect();
        return {
                mousePosition: [
                  rect.x + (rect.width / 2 | 0) | 0,
                  rect.y + (rect.height / 2 | 0) | 0
                ]
              };
      });
  var setState = match[1];
  var onMouseMove = function ($$event) {
    var x = $$event.clientX;
    var y = $$event.clientY;
    return Curry._1(setState, (function (_oldState) {
                  return {
                          mousePosition: [
                            x,
                            y
                          ]
                        };
                }));
  };
  var onMouseUp = function ($$event) {
    Debug.assignToWindowForDeveloperDebug("mouseupevent", $$event);
    return Curry._1(onDragEnd, undefined);
  };
  React.useEffect((function () {
          Belt_Option.forEach(Caml_option.undefined_to_opt(typeof window === "undefined" ? undefined : window), (function ($$window) {
                  $$window.document.addEventListener("mousemove", onMouseMove);
                  return $$window.document.addEventListener("mouseup", onMouseUp);
                }));
          return Belt_Option.map(Caml_option.undefined_to_opt(typeof window === "undefined" ? undefined : window), (function ($$window, param) {
                        $$window.document.removeEventListener("mousemove", onMouseMove);
                        return $$window.document.removeEventListener("mouseup", onMouseUp);
                      }));
        }), []);
  var match$1 = match[0].mousePosition;
  var mouseY = match$1[1];
  var mouseX = match$1[0];
  var rect = source.getBoundingClientRect();
  var anchorX = rect.x + (rect.width / 2 | 0) | 0;
  var anchorY = rect.y + (rect.height / 2 | 0) | 0;
  var match$2 = invert ? [
      mouseX,
      mouseY,
      anchorX,
      anchorY
    ] : [
      anchorX,
      anchorY,
      mouseX,
      mouseY
    ];
  var endY = match$2[3];
  var endX = match$2[2];
  var startY = match$2[1];
  var startX = match$2[0];
  return React.createElement("div", {
              className: "absolute w-full h-full pointer-events-none",
              style: {
                cursor: "none",
                left: "0px",
                top: "0px",
                zIndex: "9999"
              },
              onMouseMove: (function ($$event) {
                  var x = $$event.clientX;
                  var y = $$event.clientY;
                  return Curry._1(setState, (function (_oldState) {
                                return {
                                        mousePosition: [
                                          x,
                                          y
                                        ]
                                      };
                              }));
                })
            }, React.createElement("svg", {
                  className: "relative w-full h-full pointer-events-none",
                  style: {
                    cursor: "none",
                    left: "0px",
                    top: "0px",
                    zIndex: "9999"
                  },
                  xmlns: "http://www.w3.org/2000/svg"
                }, React.createElement("filter", {
                      id: "blurMe"
                    }, React.createElement("feGaussianBlur", {
                          in: "SourceGraphic",
                          stdDeviation: "5"
                        })), React.createElement("marker", {
                      id: "connectMarker",
                      markerHeight: "4",
                      markerWidth: "2",
                      orient: "auto",
                      refX: "0.1",
                      refY: "2"
                    }, React.createElement("path", {
                          d: "M0 0v4l2-2z",
                          fill: "green"
                        })), React.createElement("line", {
                      style: {
                        cursor: "none"
                      },
                      markerEnd: "url(#connectMarker)",
                      stroke: "green",
                      strokeWidth: "3",
                      x1: String(startX),
                      x2: String(endX),
                      y1: String(startY),
                      y2: String(endY)
                    }), React.createElement("line", {
                      className: "moving-path",
                      style: {
                        cursor: "none"
                      },
                      filter: "url(#blurMe)",
                      markerEnd: "url(#connectMarker)",
                      stroke: "#22ff22",
                      strokeDasharray: "50",
                      strokeWidth: "4",
                      x1: String(startX),
                      x2: String(endX),
                      y1: String(startY),
                      y2: String(endY)
                    })));
}

var ConnectorLine = {
  make: ChainEditor$ConnectorLine
};

function ChainEditor$Diagram(Props) {
  var setState = Props.setState;
  var diagram = Props.diagram;
  var chain = Props.chain;
  var removeEdge = Props.removeEdge;
  var removeRequest = Props.removeRequest;
  var diagramFromChain = Props.diagramFromChain;
  return React.createElement(ReactFlowRenderer$1, {
              elements: diagram.elements,
              style: {
                borderColor: Comps.colors["gray-10"],
                borderStyle: "solid",
                borderWidth: "1px"
              },
              onElementClick: (function (param, node) {
                  var id = node.id;
                  var request = Belt_Option.map(Belt_Array.getBy(chain.requests, (function (req) {
                              return req.operation.id.toString() === id;
                            })), (function (req) {
                          return {
                                  TAG: 2,
                                  chain: chain,
                                  request: req,
                                  [Symbol.for("name")]: "Request"
                                };
                        }));
                  var inspected;
                  if (request !== undefined) {
                    inspected = request;
                  } else {
                    var block = Belt_Array.getBy(chain.blocks, (function (block) {
                            return block.id.toString() === id;
                          }));
                    inspected = Belt_Option.map(block, (function (block) {
                            return {
                                    TAG: 1,
                                    _0: block,
                                    [Symbol.for("name")]: "Block"
                                  };
                          }));
                  }
                  return Belt_Option.forEach(inspected, (function (inspected) {
                                return Curry._1(setState, (function (oldState) {
                                              return {
                                                      diagram: oldState.diagram,
                                                      card: oldState.card,
                                                      schema: oldState.schema,
                                                      chain: oldState.chain,
                                                      compiledChain: oldState.compiledChain,
                                                      chainResult: oldState.chainResult,
                                                      scriptFunctions: oldState.scriptFunctions,
                                                      chainExecutionResults: oldState.chainExecutionResults,
                                                      blocks: oldState.blocks,
                                                      inspected: inspected,
                                                      blockEdit: oldState.blockEdit,
                                                      scriptEditor: oldState.scriptEditor,
                                                      savedChainId: oldState.savedChainId,
                                                      requestValueCache: oldState.requestValueCache,
                                                      debugUIItems: oldState.debugUIItems,
                                                      connectionDrag: oldState.connectionDrag
                                                    };
                                            }));
                              }));
                }),
              onElementsRemove: (function (elements) {
                  return Curry._1(setState, (function (oldState) {
                                var newChain = Belt_Array.reduce(elements, oldState.chain, (function (accChain, element) {
                                        var match = element.source;
                                        var match$1 = element.target;
                                        var typ = match !== undefined && match$1 !== undefined ? ({
                                              NAME: "edge",
                                              VAL: [
                                                match,
                                                match$1
                                              ]
                                            }) : ({
                                              NAME: "node",
                                              VAL: element.id
                                            });
                                        if (typ.NAME === "node") {
                                          var source = typ.VAL;
                                          var targetRequest = Belt_Array.getBy(accChain.requests, (function (request) {
                                                  return Caml_obj.caml_equal(request.operation.id, source);
                                                }));
                                          return Belt_Option.getWithDefault(Belt_Option.map(targetRequest, (function (targetRequest) {
                                                            return Curry._2(removeRequest, accChain, targetRequest);
                                                          })), accChain);
                                        }
                                        var match$2 = typ.VAL;
                                        return Curry._3(removeEdge, accChain, match$2[0], match$2[1]);
                                      }));
                                var diagram = Curry._1(diagramFromChain, newChain);
                                return {
                                        diagram: diagram,
                                        card: oldState.card,
                                        schema: oldState.schema,
                                        chain: newChain,
                                        compiledChain: oldState.compiledChain,
                                        chainResult: oldState.chainResult,
                                        scriptFunctions: oldState.scriptFunctions,
                                        chainExecutionResults: oldState.chainExecutionResults,
                                        blocks: oldState.blocks,
                                        inspected: oldState.inspected,
                                        blockEdit: oldState.blockEdit,
                                        scriptEditor: oldState.scriptEditor,
                                        savedChainId: oldState.savedChainId,
                                        requestValueCache: oldState.requestValueCache,
                                        debugUIItems: oldState.debugUIItems,
                                        connectionDrag: oldState.connectionDrag
                                      };
                              }));
                }),
              connectionLineType: "smoothstep",
              onPaneClick: (function (param) {
                  return Curry._1(setState, (function (oldState) {
                                return {
                                        diagram: oldState.diagram,
                                        card: oldState.card,
                                        schema: oldState.schema,
                                        chain: oldState.chain,
                                        compiledChain: oldState.compiledChain,
                                        chainResult: oldState.chainResult,
                                        scriptFunctions: oldState.scriptFunctions,
                                        chainExecutionResults: oldState.chainExecutionResults,
                                        blocks: oldState.blocks,
                                        inspected: {
                                          TAG: 0,
                                          _0: oldState.chain,
                                          [Symbol.for("name")]: "Nothing"
                                        },
                                        blockEdit: oldState.blockEdit,
                                        scriptEditor: oldState.scriptEditor,
                                        savedChainId: oldState.savedChainId,
                                        requestValueCache: oldState.requestValueCache,
                                        debugUIItems: oldState.debugUIItems,
                                        connectionDrag: oldState.connectionDrag
                                      };
                              }));
                }),
              onConnect: (function (info) {
                  var source = info.source;
                  var target = info.target;
                  var sourceRequest = Belt_Array.getBy(chain.requests, (function (request) {
                          return request.operation.id.toString() === source;
                        }));
                  var targetRequest = Belt_Array.getBy(chain.requests, (function (request) {
                          return request.operation.id.toString() === target;
                        }));
                  if (sourceRequest !== undefined && targetRequest !== undefined) {
                    return Curry._1(setState, (function (oldState) {
                                  var newRequests = Belt_Array.map(oldState.chain.requests, (function (request) {
                                          if (targetRequest.id !== request.id) {
                                            return request;
                                          }
                                          var varDeps = Belt_Array.map(request.variableDependencies, (function (varDep) {
                                                  var argDep = varDep.dependency;
                                                  var dependency;
                                                  switch (argDep.TAG | 0) {
                                                    case /* ArgumentDependency */0 :
                                                        var argDep$1 = argDep._0;
                                                        var newArgDep_functionFromScript = argDep$1.functionFromScript;
                                                        var newArgDep_maxRecur = argDep$1.maxRecur;
                                                        var newArgDep_ifMissing = argDep$1.ifMissing;
                                                        var newArgDep_ifList = argDep$1.ifList;
                                                        var newArgDep_fromRequestIds = Utils.distinctStrings(Belt_Array.concat(argDep$1.fromRequestIds, [sourceRequest.id]));
                                                        var newArgDep_name = argDep$1.name;
                                                        var newArgDep = {
                                                          functionFromScript: newArgDep_functionFromScript,
                                                          maxRecur: newArgDep_maxRecur,
                                                          ifMissing: newArgDep_ifMissing,
                                                          ifList: newArgDep_ifList,
                                                          fromRequestIds: newArgDep_fromRequestIds,
                                                          name: newArgDep_name
                                                        };
                                                        dependency = {
                                                          TAG: 0,
                                                          _0: newArgDep,
                                                          [Symbol.for("name")]: "ArgumentDependency"
                                                        };
                                                        break;
                                                    case /* Direct */1 :
                                                    case /* GraphQLProbe */2 :
                                                        dependency = argDep;
                                                        break;
                                                    
                                                  }
                                                  return {
                                                          name: varDep.name,
                                                          dependency: dependency
                                                        };
                                                }));
                                          return {
                                                  id: request.id,
                                                  variableDependencies: varDeps,
                                                  operation: request.operation,
                                                  dependencyRequestIds: Utils.distinctStrings(Belt_Array.concat(request.dependencyRequestIds, [sourceRequest.id]))
                                                };
                                        }));
                                  var sortedRequests = Chain.toposortRequests(newRequests);
                                  if (sortedRequests.TAG !== /* Ok */0) {
                                    return oldState;
                                  }
                                  var init = oldState.chain;
                                  var newChain_name = init.name;
                                  var newChain_script = init.script;
                                  var newChain_scriptDependencies = init.scriptDependencies;
                                  var newChain_requests = sortedRequests._0;
                                  var newChain_blocks = init.blocks;
                                  var newChain = {
                                    name: newChain_name,
                                    script: newChain_script,
                                    scriptDependencies: newChain_scriptDependencies,
                                    requests: newChain_requests,
                                    blocks: newChain_blocks
                                  };
                                  var diagram = Curry._1(diagramFromChain, newChain);
                                  return {
                                          diagram: diagram,
                                          card: oldState.card,
                                          schema: oldState.schema,
                                          chain: newChain,
                                          compiledChain: oldState.compiledChain,
                                          chainResult: oldState.chainResult,
                                          scriptFunctions: oldState.scriptFunctions,
                                          chainExecutionResults: oldState.chainExecutionResults,
                                          blocks: oldState.blocks,
                                          inspected: oldState.inspected,
                                          blockEdit: oldState.blockEdit,
                                          scriptEditor: oldState.scriptEditor,
                                          savedChainId: oldState.savedChainId,
                                          requestValueCache: oldState.requestValueCache,
                                          debugUIItems: oldState.debugUIItems,
                                          connectionDrag: oldState.connectionDrag
                                        };
                                }));
                  } else {
                    console.warn("Couldn't find source or target request to connect");
                    return ;
                  }
                }),
              zoomOnScroll: false,
              panOnScroll: true,
              onNodeContextMenu: (function (_event, _node) {
                  
                }),
              onPaneContextMenu: (function ($$event) {
                  
                }),
              children: null,
              nodeTypes: {
                fragment: make,
                operation: ChainEditor$OperationNodeComponent
              }
            }, React.createElement(ReactFlowRenderer.Controls, {
                  showZoom: false,
                  showFitView: true,
                  showInteractive: false
                }), React.createElement(ReactFlowRenderer.Background, {
                  variant: "lines",
                  gap: 20,
                  size: 1,
                  color: "rgb(34, 37, 40)",
                  style: {
                    backgroundColor: "rgb(31, 33, 37)"
                  }
                }));
}

var Diagram = {
  make: ChainEditor$Diagram
};

function ChainEditor$Main(Props) {
  var schema = Props.schema;
  var initialChain = Props.initialChain;
  var config = Props.config;
  var oneGraphAuth = Props.oneGraphAuth;
  var match = React.useState(function () {
        return [];
      });
  var setMissingAuthServices = match[1];
  var match$1 = React.useState(function () {
        var scriptFunctions;
        try {
          scriptFunctions = Acorn.collectExportedFunctionNames(Acorn$1.parse(initialChain.script, {
                    ecmaVersion: 2020,
                    sourceType: "module"
                  }));
        }
        catch (exn){
          scriptFunctions = [];
        }
        var inspected_1 = Belt_Option.getExn(Belt_Array.get(initialChain.requests, 1));
        var inspected = {
          TAG: 2,
          chain: initialChain,
          request: inspected_1,
          [Symbol.for("name")]: "Request"
        };
        return {
                diagram: undefined,
                card: Card.watchTwitterFollower,
                schema: schema,
                chain: initialChain,
                compiledChain: compileChain(schema, initialChain),
                chainResult: undefined,
                scriptFunctions: scriptFunctions,
                chainExecutionResults: undefined,
                blocks: Card.blocks,
                inspected: inspected,
                blockEdit: /* Nothing */0,
                scriptEditor: {
                  isOpen: true,
                  editor: undefined,
                  monaco: undefined
                },
                savedChainId: undefined,
                requestValueCache: {},
                debugUIItems: [],
                connectionDrag: /* Empty */0
              };
      });
  var setState = match$1[1];
  var state = match$1[0];
  React.useEffect((function () {
          var diagramFromChain$1 = function (chain) {
            return diagramFromChain(chain, (function (block) {
                          return Curry._1(setState, (function (oldState) {
                                        return {
                                                diagram: oldState.diagram,
                                                card: oldState.card,
                                                schema: oldState.schema,
                                                chain: oldState.chain,
                                                compiledChain: oldState.compiledChain,
                                                chainResult: oldState.chainResult,
                                                scriptFunctions: oldState.scriptFunctions,
                                                chainExecutionResults: oldState.chainExecutionResults,
                                                blocks: oldState.blocks,
                                                inspected: oldState.inspected,
                                                blockEdit: {
                                                  TAG: 1,
                                                  _0: block,
                                                  [Symbol.for("name")]: "Edit"
                                                },
                                                scriptEditor: oldState.scriptEditor,
                                                savedChainId: oldState.savedChainId,
                                                requestValueCache: oldState.requestValueCache,
                                                debugUIItems: oldState.debugUIItems,
                                                connectionDrag: oldState.connectionDrag
                                              };
                                      }));
                        }), (function (param, request, domRef) {
                          var connectionDrag = Belt_Option.mapWithDefault((domRef == null) ? undefined : Caml_option.some(domRef), /* Empty */0, (function (domRef) {
                                  return {
                                          TAG: 0,
                                          sourceRequest: request,
                                          sourceDom: domRef,
                                          [Symbol.for("name")]: "StartedSource"
                                        };
                                }));
                          return Curry._1(setState, (function (oldState) {
                                        return {
                                                diagram: oldState.diagram,
                                                card: oldState.card,
                                                schema: oldState.schema,
                                                chain: oldState.chain,
                                                compiledChain: oldState.compiledChain,
                                                chainResult: oldState.chainResult,
                                                scriptFunctions: oldState.scriptFunctions,
                                                chainExecutionResults: oldState.chainExecutionResults,
                                                blocks: oldState.blocks,
                                                inspected: oldState.inspected,
                                                blockEdit: oldState.blockEdit,
                                                scriptEditor: oldState.scriptEditor,
                                                savedChainId: oldState.savedChainId,
                                                requestValueCache: oldState.requestValueCache,
                                                debugUIItems: oldState.debugUIItems,
                                                connectionDrag: connectionDrag
                                              };
                                      }));
                        }), schema, (function (param) {
                          
                        }), undefined);
          };
          var diagram = diagramFromChain$1(state.chain);
          Curry._1(setState, (function (oldState) {
                  return {
                          diagram: diagram,
                          card: oldState.card,
                          schema: oldState.schema,
                          chain: oldState.chain,
                          compiledChain: oldState.compiledChain,
                          chainResult: oldState.chainResult,
                          scriptFunctions: oldState.scriptFunctions,
                          chainExecutionResults: oldState.chainExecutionResults,
                          blocks: oldState.blocks,
                          inspected: oldState.inspected,
                          blockEdit: oldState.blockEdit,
                          scriptEditor: oldState.scriptEditor,
                          savedChainId: oldState.savedChainId,
                          requestValueCache: oldState.requestValueCache,
                          debugUIItems: oldState.debugUIItems,
                          connectionDrag: oldState.connectionDrag
                        };
                }));
          
        }), []);
  var onPotentialVariableSourceConnect = function (connectionDrag) {
    return Curry._1(setState, (function (oldState) {
                  return {
                          diagram: oldState.diagram,
                          card: oldState.card,
                          schema: oldState.schema,
                          chain: oldState.chain,
                          compiledChain: oldState.compiledChain,
                          chainResult: oldState.chainResult,
                          scriptFunctions: oldState.scriptFunctions,
                          chainExecutionResults: oldState.chainExecutionResults,
                          blocks: oldState.blocks,
                          inspected: oldState.inspected,
                          blockEdit: oldState.blockEdit,
                          scriptEditor: oldState.scriptEditor,
                          savedChainId: oldState.savedChainId,
                          requestValueCache: oldState.requestValueCache,
                          debugUIItems: oldState.debugUIItems,
                          connectionDrag: connectionDrag
                        };
                }));
  };
  var diagramFromChain$1 = function (chain) {
    return diagramFromChain(chain, (function (block) {
                  return Curry._1(setState, (function (oldState) {
                                return {
                                        diagram: oldState.diagram,
                                        card: oldState.card,
                                        schema: oldState.schema,
                                        chain: oldState.chain,
                                        compiledChain: oldState.compiledChain,
                                        chainResult: oldState.chainResult,
                                        scriptFunctions: oldState.scriptFunctions,
                                        chainExecutionResults: oldState.chainExecutionResults,
                                        blocks: oldState.blocks,
                                        inspected: oldState.inspected,
                                        blockEdit: {
                                          TAG: 1,
                                          _0: block,
                                          [Symbol.for("name")]: "Edit"
                                        },
                                        scriptEditor: oldState.scriptEditor,
                                        savedChainId: oldState.savedChainId,
                                        requestValueCache: oldState.requestValueCache,
                                        debugUIItems: oldState.debugUIItems,
                                        connectionDrag: oldState.connectionDrag
                                      };
                              }));
                }), (function (param, request, domRef) {
                  var connectionDrag = Belt_Option.mapWithDefault((domRef == null) ? undefined : Caml_option.some(domRef), /* Empty */0, (function (domRef) {
                          return {
                                  TAG: 0,
                                  sourceRequest: request,
                                  sourceDom: domRef,
                                  [Symbol.for("name")]: "StartedSource"
                                };
                        }));
                  return Curry._1(setState, (function (oldState) {
                                return {
                                        diagram: oldState.diagram,
                                        card: oldState.card,
                                        schema: oldState.schema,
                                        chain: oldState.chain,
                                        compiledChain: oldState.compiledChain,
                                        chainResult: oldState.chainResult,
                                        scriptFunctions: oldState.scriptFunctions,
                                        chainExecutionResults: oldState.chainExecutionResults,
                                        blocks: oldState.blocks,
                                        inspected: oldState.inspected,
                                        blockEdit: oldState.blockEdit,
                                        scriptEditor: oldState.scriptEditor,
                                        savedChainId: oldState.savedChainId,
                                        requestValueCache: oldState.requestValueCache,
                                        debugUIItems: oldState.debugUIItems,
                                        connectionDrag: connectionDrag
                                      };
                              }));
                }), schema, onPotentialVariableSourceConnect, undefined);
  };
  var match$2 = ReactFlowRenderer.useZoomPanHelper();
  var fitView = match$2.fitView;
  var onRequestInspected = function (request) {
    var inspected_0 = state.chain;
    var inspected = {
      TAG: 2,
      chain: inspected_0,
      request: request,
      [Symbol.for("name")]: "Request"
    };
    return Curry._1(setState, (function (oldState) {
                  return {
                          diagram: oldState.diagram,
                          card: oldState.card,
                          schema: oldState.schema,
                          chain: oldState.chain,
                          compiledChain: oldState.compiledChain,
                          chainResult: oldState.chainResult,
                          scriptFunctions: oldState.scriptFunctions,
                          chainExecutionResults: oldState.chainExecutionResults,
                          blocks: oldState.blocks,
                          inspected: inspected,
                          blockEdit: oldState.blockEdit,
                          scriptEditor: oldState.scriptEditor,
                          savedChainId: oldState.savedChainId,
                          requestValueCache: oldState.requestValueCache,
                          debugUIItems: oldState.debugUIItems,
                          connectionDrag: oldState.connectionDrag
                        };
                }));
  };
  React.useEffect((function () {
          try {
            var parsedScript = Acorn$1.parse(state.chain.script, {
                  ecmaVersion: 2020,
                  sourceType: "module"
                });
            var functionNames = Acorn.collectExportedFunctionNames(parsedScript);
            Curry._1(setState, (function (oldState) {
                    return {
                            diagram: oldState.diagram,
                            card: oldState.card,
                            schema: oldState.schema,
                            chain: oldState.chain,
                            compiledChain: oldState.compiledChain,
                            chainResult: oldState.chainResult,
                            scriptFunctions: functionNames,
                            chainExecutionResults: oldState.chainExecutionResults,
                            blocks: oldState.blocks,
                            inspected: oldState.inspected,
                            blockEdit: oldState.blockEdit,
                            scriptEditor: oldState.scriptEditor,
                            savedChainId: oldState.savedChainId,
                            requestValueCache: oldState.requestValueCache,
                            debugUIItems: oldState.debugUIItems,
                            connectionDrag: oldState.connectionDrag
                          };
                  }));
          }
          catch (exn){
            
          }
          
        }), [state.chain.script]);
  React.useEffect((function () {
          if (state.chain.requests.length > 3) {
            Curry._1(fitView, {
                  padding: 0.2,
                  includeHiddenNodes: false
                });
          }
          
        }), [state.chain.requests.length]);
  var onExecuteRequest = function (request, variables) {
    var ast = Graphql.parse(request.operation.body);
    var operationName = Caml_array.get(ast.definitions, 0).name.value;
    var chainFragments = Belt_Array.keepMap(state.chain.blocks, (function (block) {
              var match = block.kind;
              if (match >= 3) {
                return block.body;
              }
              
            })).join("\n\n");
    var fullDoc = (request.operation.body + "\n\n" + chainFragments).trim();
    var promise = OneGraphRe.fetchOneGraph(oneGraphAuth, fullDoc, operationName, Caml_option.some(variables));
    promise.then(function (result) {
          return Promise.resolve(Curry._1(setState, (function (oldState) {
                            oldState.requestValueCache[request.id] = result;
                            var newOne = Js_dict.fromArray(Js_dict.entries(oldState.requestValueCache));
                            return {
                                    diagram: oldState.diagram,
                                    card: oldState.card,
                                    schema: oldState.schema,
                                    chain: oldState.chain,
                                    compiledChain: oldState.compiledChain,
                                    chainResult: oldState.chainResult,
                                    scriptFunctions: oldState.scriptFunctions,
                                    chainExecutionResults: oldState.chainExecutionResults,
                                    blocks: oldState.blocks,
                                    inspected: oldState.inspected,
                                    blockEdit: oldState.blockEdit,
                                    scriptEditor: oldState.scriptEditor,
                                    savedChainId: oldState.savedChainId,
                                    requestValueCache: newOne,
                                    debugUIItems: oldState.debugUIItems,
                                    connectionDrag: oldState.connectionDrag
                                  };
                          })));
        });
    
  };
  var addBlock = function (superBlock) {
    var ast = Graphql.parse(superBlock.body);
    var blocks = Belt_Array.map(ast.definitions, (function (definition) {
            var services = Belt_Array.map(GraphQLUtils.gatherAllReferencedServices(schema, definition), (function (service) {
                    return service.slug;
                  }));
            var blank = makeBlankBlock(undefined);
            var match = definition.operation;
            return {
                    id: Uuid.v4(),
                    title: definition.name.value,
                    description: blank.description,
                    body: Graphql.print(definition),
                    kind: match !== undefined ? (
                        match === "mutation" ? /* Mutation */1 : (
                            match === "subscription" ? /* Subscription */2 : /* Query */0
                          )
                      ) : /* Fragment */3,
                    contributedBy: blank.contributedBy,
                    services: services
                  };
          }));
    var inspectedReq = {
      contents: undefined
    };
    var newChain = Belt_Array.reduce(blocks, state.chain, (function (newChain, block) {
            var match = block.kind;
            if (match >= 3) {
              return {
                      name: newChain.name,
                      script: newChain.script,
                      scriptDependencies: newChain.scriptDependencies,
                      requests: newChain.requests,
                      blocks: Belt_Array.concat(newChain.blocks, [block])
                    };
            }
            var operationDoc = Graphql.parse(block.body);
            var definition = Caml_array.get(operationDoc.definitions, 0);
            var variableNames = GraphQLUtils.getOperationVariables(definition);
            var variableDependencies = Belt_Array.map(variableNames, (function (param) {
                    var variableName = param[0];
                    return {
                            name: variableName,
                            dependency: {
                              TAG: 1,
                              _0: {
                                name: variableName,
                                value: {
                                  TAG: 1,
                                  _0: variableName,
                                  [Symbol.for("name")]: "Variable"
                                }
                              },
                              [Symbol.for("name")]: "Direct"
                            }
                          };
                  }));
            var newReq_id = block.title;
            var newReq_dependencyRequestIds = [];
            var newReq = {
              id: newReq_id,
              variableDependencies: variableDependencies,
              operation: block,
              dependencyRequestIds: newReq_dependencyRequestIds
            };
            inspectedReq.contents = newReq;
            var names = Chain.requestScriptNames(newReq);
            var nameExistsInScript = Belt_Option.isSome(Caml_option.null_to_opt(newChain.script.match(new RegExp("export function " + names.functionName))));
            var newScript = nameExistsInScript ? newChain.script : newChain.script + ("\n\nexport function " + names.functionName + " (payload : " + names.inputTypeName + ") : " + names.returnTypeName + " {\n  return {}\n}");
            var newChain_name = newChain.name;
            var newChain_scriptDependencies = newChain.scriptDependencies;
            var newChain_requests = Belt_Array.concat(newChain.requests, [newReq]);
            var newChain_blocks = Belt_Array.concat(newChain.blocks, [block]);
            var newChain$1 = {
              name: newChain_name,
              script: newScript,
              scriptDependencies: newChain_scriptDependencies,
              requests: newChain_requests,
              blocks: newChain_blocks
            };
            var match$1 = monacoTypelibForChain(schema, newChain$1);
            var importLine = match$1.importLine;
            var hasImport = Belt_Option.isSome(Caml_option.null_to_opt(newScript.match(new RegExp("import[\\s\\S.]+from[\\s\\S]+'oneGraphStudio';"))));
            var newScript$1 = hasImport ? newScript.replace(new RegExp("import[\\s\\S.]+from[\\s\\S]+'oneGraphStudio';"), importLine) : importLine + "\n\n" + newScript;
            return {
                    name: newChain_name,
                    script: newScript$1,
                    scriptDependencies: newChain_scriptDependencies,
                    requests: newChain_requests,
                    blocks: newChain_blocks
                  };
          }));
    var diagram = diagramFromChain$1(newChain);
    var inspected = Belt_Option.getWithDefault(Belt_Option.map(inspectedReq.contents, (function (request) {
                return {
                        TAG: 2,
                        chain: newChain,
                        request: request,
                        [Symbol.for("name")]: "Request"
                      };
              })), state.inspected);
    return Curry._1(setState, (function (oldState) {
                  return {
                          diagram: diagram,
                          card: oldState.card,
                          schema: oldState.schema,
                          chain: newChain,
                          compiledChain: oldState.compiledChain,
                          chainResult: oldState.chainResult,
                          scriptFunctions: oldState.scriptFunctions,
                          chainExecutionResults: oldState.chainExecutionResults,
                          blocks: oldState.blocks,
                          inspected: inspected,
                          blockEdit: oldState.blockEdit,
                          scriptEditor: oldState.scriptEditor,
                          savedChainId: oldState.savedChainId,
                          requestValueCache: oldState.requestValueCache,
                          debugUIItems: oldState.debugUIItems,
                          connectionDrag: oldState.connectionDrag
                        };
                }));
  };
  var removeRequest = function (oldChain, targetRequest) {
    var newRequests = Belt_Array.keepMap(oldChain.requests, (function (request) {
            if (request.id === targetRequest.id) {
              return ;
            }
            var varDeps = Belt_Array.map(request.variableDependencies, (function (varDep) {
                    var argDep = varDep.dependency;
                    var dependency;
                    switch (argDep.TAG | 0) {
                      case /* ArgumentDependency */0 :
                          var argDep$1 = argDep._0;
                          dependency = {
                            TAG: 0,
                            _0: {
                              functionFromScript: argDep$1.functionFromScript,
                              maxRecur: argDep$1.maxRecur,
                              ifMissing: argDep$1.ifMissing,
                              ifList: argDep$1.ifList,
                              fromRequestIds: Belt_Array.keep(argDep$1.fromRequestIds, (function (id) {
                                      return id !== targetRequest.id;
                                    })),
                              name: argDep$1.name
                            },
                            [Symbol.for("name")]: "ArgumentDependency"
                          };
                          break;
                      case /* Direct */1 :
                      case /* GraphQLProbe */2 :
                          dependency = argDep;
                          break;
                      
                    }
                    return {
                            name: varDep.name,
                            dependency: dependency
                          };
                  }));
            return {
                    id: request.id,
                    variableDependencies: varDeps,
                    operation: request.operation,
                    dependencyRequestIds: Belt_Array.keep(request.dependencyRequestIds, (function (id) {
                            return id !== targetRequest.id;
                          }))
                  };
          }));
    return {
            name: oldChain.name,
            script: oldChain.script,
            scriptDependencies: oldChain.scriptDependencies,
            requests: newRequests,
            blocks: Belt_Array.keep(oldChain.blocks, (function (oldBlock) {
                    return Caml_obj.caml_notequal(oldBlock, targetRequest.operation);
                  }))
          };
  };
  var removeEdge = function (oldChain, dependencyId, targetRequestId) {
    var newRequests = Belt_Array.map(oldChain.requests, (function (request) {
            if (request.id !== targetRequestId) {
              return request;
            }
            var varDeps = Belt_Array.map(request.variableDependencies, (function (varDep) {
                    var argDep = varDep.dependency;
                    var dependency;
                    switch (argDep.TAG | 0) {
                      case /* ArgumentDependency */0 :
                          var argDep$1 = argDep._0;
                          dependency = {
                            TAG: 0,
                            _0: {
                              functionFromScript: argDep$1.functionFromScript,
                              maxRecur: argDep$1.maxRecur,
                              ifMissing: argDep$1.ifMissing,
                              ifList: argDep$1.ifList,
                              fromRequestIds: Belt_Array.keep(argDep$1.fromRequestIds, (function (id) {
                                      return id !== dependencyId;
                                    })),
                              name: argDep$1.name
                            },
                            [Symbol.for("name")]: "ArgumentDependency"
                          };
                          break;
                      case /* Direct */1 :
                      case /* GraphQLProbe */2 :
                          dependency = argDep;
                          break;
                      
                    }
                    return {
                            name: varDep.name,
                            dependency: dependency
                          };
                  }));
            return {
                    id: request.id,
                    variableDependencies: varDeps,
                    operation: request.operation,
                    dependencyRequestIds: Belt_Array.keep(request.dependencyRequestIds, (function (id) {
                            return id !== dependencyId;
                          }))
                  };
          }));
    return {
            name: oldChain.name,
            script: oldChain.script,
            scriptDependencies: oldChain.scriptDependencies,
            requests: newRequests,
            blocks: oldChain.blocks
          };
  };
  var blockSearch = React.createElement(ChainEditor$BlockSearch, {
        onAdd: addBlock,
        onInspect: (function (block) {
            return Curry._1(setState, (function (oldState) {
                          return {
                                  diagram: oldState.diagram,
                                  card: oldState.card,
                                  schema: oldState.schema,
                                  chain: oldState.chain,
                                  compiledChain: oldState.compiledChain,
                                  chainResult: oldState.chainResult,
                                  scriptFunctions: oldState.scriptFunctions,
                                  chainExecutionResults: oldState.chainExecutionResults,
                                  blocks: oldState.blocks,
                                  inspected: {
                                    TAG: 1,
                                    _0: block,
                                    [Symbol.for("name")]: "Block"
                                  },
                                  blockEdit: oldState.blockEdit,
                                  scriptEditor: oldState.scriptEditor,
                                  savedChainId: oldState.savedChainId,
                                  requestValueCache: oldState.requestValueCache,
                                  debugUIItems: oldState.debugUIItems,
                                  connectionDrag: oldState.connectionDrag
                                };
                        }));
          }),
        blocks: state.blocks,
        onCreate: (function (param) {
            return Curry._1(setState, (function (oldState) {
                          return {
                                  diagram: oldState.diagram,
                                  card: oldState.card,
                                  schema: oldState.schema,
                                  chain: oldState.chain,
                                  compiledChain: oldState.compiledChain,
                                  chainResult: oldState.chainResult,
                                  scriptFunctions: oldState.scriptFunctions,
                                  chainExecutionResults: oldState.chainExecutionResults,
                                  blocks: oldState.blocks,
                                  inspected: oldState.inspected,
                                  blockEdit: {
                                    TAG: 0,
                                    _0: makeBlankBlock(undefined),
                                    [Symbol.for("name")]: "Create"
                                  },
                                  scriptEditor: oldState.scriptEditor,
                                  savedChainId: oldState.savedChainId,
                                  requestValueCache: oldState.requestValueCache,
                                  debugUIItems: oldState.debugUIItems,
                                  connectionDrag: oldState.connectionDrag
                                };
                        }));
          })
      });
  var sidebar = React.createElement(Inspector.make, {
        inspected: state.inspected,
        onAddBlock: addBlock,
        onChainUpdated: (function (newChain) {
            var block = state.inspected;
            var inspected;
            switch (block.TAG | 0) {
              case /* Nothing */0 :
                  inspected = {
                    TAG: 0,
                    _0: newChain,
                    [Symbol.for("name")]: "Nothing"
                  };
                  break;
              case /* Block */1 :
                  inspected = {
                    TAG: 1,
                    _0: block._0,
                    [Symbol.for("name")]: "Block"
                  };
                  break;
              case /* Request */2 :
                  var request = Belt_Option.getWithDefault(Belt_Array.getBy(newChain.requests, (function (existingRequest) {
                              return existingRequest.id === block.request.id;
                            })), block.request);
                  inspected = {
                    TAG: 2,
                    chain: newChain,
                    request: request,
                    [Symbol.for("name")]: "Request"
                  };
                  break;
              case /* RequestArgument */3 :
                  var request$1 = block.request;
                  var request$2 = Belt_Option.getWithDefault(Belt_Array.getBy(newChain.requests, (function (existingRequest) {
                              return existingRequest.id === request$1.id;
                            })), request$1);
                  inspected = {
                    TAG: 3,
                    chain: newChain,
                    request: request$2,
                    variableName: block.variableName,
                    [Symbol.for("name")]: "RequestArgument"
                  };
                  break;
              
            }
            var diagram = diagramFromChain$1(newChain);
            return Curry._1(setState, (function (oldState) {
                          return {
                                  diagram: diagram,
                                  card: oldState.card,
                                  schema: oldState.schema,
                                  chain: newChain,
                                  compiledChain: oldState.compiledChain,
                                  chainResult: oldState.chainResult,
                                  scriptFunctions: oldState.scriptFunctions,
                                  chainExecutionResults: oldState.chainExecutionResults,
                                  blocks: oldState.blocks,
                                  inspected: inspected,
                                  blockEdit: oldState.blockEdit,
                                  scriptEditor: oldState.scriptEditor,
                                  savedChainId: oldState.savedChainId,
                                  requestValueCache: oldState.requestValueCache,
                                  debugUIItems: oldState.debugUIItems,
                                  connectionDrag: oldState.connectionDrag
                                };
                        }));
          }),
        onReset: (function (param) {
            return Curry._1(setState, (function (oldState) {
                          return {
                                  diagram: oldState.diagram,
                                  card: oldState.card,
                                  schema: oldState.schema,
                                  chain: oldState.chain,
                                  compiledChain: oldState.compiledChain,
                                  chainResult: oldState.chainResult,
                                  scriptFunctions: oldState.scriptFunctions,
                                  chainExecutionResults: oldState.chainExecutionResults,
                                  blocks: oldState.blocks,
                                  inspected: {
                                    TAG: 0,
                                    _0: state.chain,
                                    [Symbol.for("name")]: "Nothing"
                                  },
                                  blockEdit: oldState.blockEdit,
                                  scriptEditor: oldState.scriptEditor,
                                  savedChainId: oldState.savedChainId,
                                  requestValueCache: oldState.requestValueCache,
                                  debugUIItems: oldState.debugUIItems,
                                  connectionDrag: oldState.connectionDrag
                                };
                        }));
          }),
        chain: state.chain,
        schema: state.schema,
        chainExecutionResults: state.chainExecutionResults,
        onLogin: (function (service) {
            var __x = oneGraphAuth.login(service);
            __x.then(function (param) {
                  var __x = oneGraphAuth.isLoggedIn(service);
                  return __x.then(function (isLoggedIn) {
                              return Promise.resolve(isLoggedIn ? Curry._1(setMissingAuthServices, (function (oldMissingAuthServices) {
                                                  return Belt_Array.keep(oldMissingAuthServices, (function (oldService) {
                                                                return oldService !== service;
                                                              }));
                                                })) : undefined);
                            });
                });
            
          }),
        transformAndExecuteChain: (function (variables) {
            var __x = Inspector.transformAndExecuteChain(state.chain, oneGraphAuth, variables);
            __x.then(function (result) {
                  return Promise.resolve(Curry._1(setState, (function (oldState) {
                                    return {
                                            diagram: oldState.diagram,
                                            card: oldState.card,
                                            schema: oldState.schema,
                                            chain: oldState.chain,
                                            compiledChain: oldState.compiledChain,
                                            chainResult: oldState.chainResult,
                                            scriptFunctions: oldState.scriptFunctions,
                                            chainExecutionResults: result,
                                            blocks: oldState.blocks,
                                            inspected: oldState.inspected,
                                            blockEdit: oldState.blockEdit,
                                            scriptEditor: oldState.scriptEditor,
                                            savedChainId: oldState.savedChainId,
                                            requestValueCache: oldState.requestValueCache,
                                            debugUIItems: oldState.debugUIItems,
                                            connectionDrag: oldState.connectionDrag
                                          };
                                  })));
                });
            
          }),
        onPersistChain: (function (param) {
            var compiled = Inspector.transformChain(state.chain);
            var targetChain = compiled.chains[0];
            var freeVariables = Belt_Array.map(targetChain.exposedVariables, (function (exposed) {
                    return exposed.exposedName;
                  }));
            return OneGraphRe.persistQuery(config.oneGraphAppId, config.persistQueryToken, compiled.operationDoc, freeVariables, config.chainAccessToken, undefined, (function (results) {
                          try {
                            var docId = results.data.oneGraph.createPersistedQuery.persistedQuery.id;
                            Chain.saveToLocalStorage(state.chain, docId);
                            return Curry._1(setState, (function (oldState) {
                                          return {
                                                  diagram: oldState.diagram,
                                                  card: oldState.card,
                                                  schema: oldState.schema,
                                                  chain: oldState.chain,
                                                  compiledChain: oldState.compiledChain,
                                                  chainResult: oldState.chainResult,
                                                  scriptFunctions: oldState.scriptFunctions,
                                                  chainExecutionResults: oldState.chainExecutionResults,
                                                  blocks: oldState.blocks,
                                                  inspected: oldState.inspected,
                                                  blockEdit: oldState.blockEdit,
                                                  scriptEditor: oldState.scriptEditor,
                                                  savedChainId: docId,
                                                  requestValueCache: oldState.requestValueCache,
                                                  debugUIItems: oldState.debugUIItems,
                                                  connectionDrag: oldState.connectionDrag
                                                };
                                        }));
                          }
                          catch (raw_ex){
                            var ex = Caml_js_exceptions.internalToOCamlException(raw_ex);
                            console.error("Error saving chain locally", ex);
                            return ;
                          }
                        }));
          }),
        savedChainId: state.savedChainId,
        onRequestCodeInspected: (function (request) {
            var names = Chain.requestScriptNames(request);
            var functionName = names.functionName;
            var source = state.chain.script;
            var sourceFile = Typescript.createSourceFile("main.ts", source, 99, true);
            var pos = TypeScript.findFnPos(sourceFile, functionName);
            return Belt_Option.forEach(pos, (function (param) {
                          var end = param[1];
                          var start = param[0];
                          return Belt_Option.forEach(state.scriptEditor.editor, (function (editor) {
                                        var model = editor.getModel("file://main.tsx");
                                        var start$1 = model.getPositionAt(start);
                                        var end$1 = model.getPositionAt(end);
                                        editor.revealLineInCenter(start$1.lineNumber, 1);
                                        editor.setSelection({
                                              startLineNumber: start$1.lineNumber,
                                              startColumn: start$1.column,
                                              endLineNumber: end$1.lineNumber,
                                              endColumn: end$1.column
                                            });
                                        
                                      }));
                        }));
          }),
        onExecuteRequest: onExecuteRequest,
        requestValueCache: state.requestValueCache,
        onDeleteRequest: (function (targetRequest) {
            return Curry._1(setState, (function (oldState) {
                          var newChain = removeRequest(oldState.chain, targetRequest);
                          var diagram = diagramFromChain$1(newChain);
                          return {
                                  diagram: diagram,
                                  card: oldState.card,
                                  schema: oldState.schema,
                                  chain: newChain,
                                  compiledChain: oldState.compiledChain,
                                  chainResult: oldState.chainResult,
                                  scriptFunctions: oldState.scriptFunctions,
                                  chainExecutionResults: oldState.chainExecutionResults,
                                  blocks: oldState.blocks,
                                  inspected: {
                                    TAG: 0,
                                    _0: newChain,
                                    [Symbol.for("name")]: "Nothing"
                                  },
                                  blockEdit: oldState.blockEdit,
                                  scriptEditor: oldState.scriptEditor,
                                  savedChainId: oldState.savedChainId,
                                  requestValueCache: oldState.requestValueCache,
                                  debugUIItems: oldState.debugUIItems,
                                  connectionDrag: oldState.connectionDrag
                                };
                        }));
          }),
        onDeleteEdge: (function (targetRequestId, dependencyId) {
            return Curry._1(setState, (function (oldState) {
                          var newChain = removeEdge(oldState.chain, dependencyId, targetRequestId);
                          var diagram = diagramFromChain$1(newChain);
                          return {
                                  diagram: diagram,
                                  card: oldState.card,
                                  schema: oldState.schema,
                                  chain: newChain,
                                  compiledChain: oldState.compiledChain,
                                  chainResult: oldState.chainResult,
                                  scriptFunctions: oldState.scriptFunctions,
                                  chainExecutionResults: oldState.chainExecutionResults,
                                  blocks: oldState.blocks,
                                  inspected: {
                                    TAG: 0,
                                    _0: newChain,
                                    [Symbol.for("name")]: "Nothing"
                                  },
                                  blockEdit: oldState.blockEdit,
                                  scriptEditor: oldState.scriptEditor,
                                  savedChainId: oldState.savedChainId,
                                  requestValueCache: oldState.requestValueCache,
                                  debugUIItems: oldState.debugUIItems,
                                  connectionDrag: oldState.connectionDrag
                                };
                        }));
          }),
        onRequestInspected: onRequestInspected,
        oneGraphAuth: oneGraphAuth,
        onPotentialVariableSourceConnect: onPotentialVariableSourceConnect,
        onDragStart: (function (connectionDrag) {
            return Curry._1(setState, (function (oldState) {
                          return {
                                  diagram: oldState.diagram,
                                  card: oldState.card,
                                  schema: oldState.schema,
                                  chain: oldState.chain,
                                  compiledChain: oldState.compiledChain,
                                  chainResult: oldState.chainResult,
                                  scriptFunctions: oldState.scriptFunctions,
                                  chainExecutionResults: oldState.chainExecutionResults,
                                  blocks: oldState.blocks,
                                  inspected: oldState.inspected,
                                  blockEdit: oldState.blockEdit,
                                  scriptEditor: oldState.scriptEditor,
                                  savedChainId: oldState.savedChainId,
                                  requestValueCache: oldState.requestValueCache,
                                  debugUIItems: oldState.debugUIItems,
                                  connectionDrag: connectionDrag
                                };
                        }));
          })
      });
  var tmp = {
    schema: state.schema,
    chain: state.chain,
    onChange: (function (newScript) {
        try {
          var init = state.chain;
          var newChain_name = init.name;
          var newChain_scriptDependencies = init.scriptDependencies;
          var newChain_requests = init.requests;
          var newChain_blocks = init.blocks;
          var newChain = {
            name: newChain_name,
            script: newScript,
            scriptDependencies: newChain_scriptDependencies,
            requests: newChain_requests,
            blocks: newChain_blocks
          };
          var functionNames = [];
          var block = state.inspected;
          var inspected;
          switch (block.TAG | 0) {
            case /* Nothing */0 :
                inspected = {
                  TAG: 0,
                  _0: newChain,
                  [Symbol.for("name")]: "Nothing"
                };
                break;
            case /* Block */1 :
                inspected = {
                  TAG: 1,
                  _0: block._0,
                  [Symbol.for("name")]: "Block"
                };
                break;
            case /* Request */2 :
                var request = Belt_Option.getWithDefault(Belt_Array.getBy(newChain_requests, (function (existingRequest) {
                            return existingRequest.id === block.request.id;
                          })), block.request);
                inspected = {
                  TAG: 2,
                  chain: newChain,
                  request: request,
                  [Symbol.for("name")]: "Request"
                };
                break;
            case /* RequestArgument */3 :
                var request$1 = block.request;
                var request$2 = Belt_Option.getWithDefault(Belt_Array.getBy(newChain_requests, (function (existingRequest) {
                            return existingRequest.id === request$1.id;
                          })), request$1);
                inspected = {
                  TAG: 3,
                  chain: newChain,
                  request: request$2,
                  variableName: block.variableName,
                  [Symbol.for("name")]: "RequestArgument"
                };
                break;
            
          }
          return Curry._1(setState, (function (oldState) {
                        return {
                                diagram: oldState.diagram,
                                card: oldState.card,
                                schema: oldState.schema,
                                chain: newChain,
                                compiledChain: oldState.compiledChain,
                                chainResult: oldState.chainResult,
                                scriptFunctions: functionNames,
                                chainExecutionResults: oldState.chainExecutionResults,
                                blocks: oldState.blocks,
                                inspected: inspected,
                                blockEdit: oldState.blockEdit,
                                scriptEditor: oldState.scriptEditor,
                                savedChainId: oldState.savedChainId,
                                requestValueCache: oldState.requestValueCache,
                                debugUIItems: oldState.debugUIItems,
                                connectionDrag: oldState.connectionDrag
                              };
                      }));
        }
        catch (raw_err){
          var err = Caml_js_exceptions.internalToOCamlException(raw_err);
          console.error("Error updating script from editor: ", err);
          return ;
        }
      }),
    onMount: (function (editor, monaco) {
        return Curry._1(setState, (function (oldState) {
                      var init = oldState.scriptEditor;
                      return {
                              diagram: oldState.diagram,
                              card: oldState.card,
                              schema: oldState.schema,
                              chain: oldState.chain,
                              compiledChain: oldState.compiledChain,
                              chainResult: oldState.chainResult,
                              scriptFunctions: oldState.scriptFunctions,
                              chainExecutionResults: oldState.chainExecutionResults,
                              blocks: oldState.blocks,
                              inspected: oldState.inspected,
                              blockEdit: oldState.blockEdit,
                              scriptEditor: {
                                isOpen: init.isOpen,
                                editor: Caml_option.some(editor),
                                monaco: Caml_option.some(monaco)
                              },
                              savedChainId: oldState.savedChainId,
                              requestValueCache: oldState.requestValueCache,
                              debugUIItems: oldState.debugUIItems,
                              connectionDrag: oldState.connectionDrag
                            };
                    }));
      }),
    onPotentialScriptSourceConnect: (function (sourceRequest, sourceDom, scriptPosition, param) {
        var y = param[1];
        var x = param[0];
        return Curry._1(setState, (function (oldState) {
                      var connectionDrag_2 = {
                        TAG: 1,
                        scriptPosition: scriptPosition,
                        [Symbol.for("name")]: "Script"
                      };
                      var connectionDrag_3 = [
                        x,
                        y
                      ];
                      var connectionDrag = {
                        TAG: 2,
                        sourceRequest: sourceRequest,
                        sourceDom: sourceDom,
                        target: connectionDrag_2,
                        windowPosition: connectionDrag_3,
                        [Symbol.for("name")]: "Completed"
                      };
                      return {
                              diagram: oldState.diagram,
                              card: oldState.card,
                              schema: oldState.schema,
                              chain: oldState.chain,
                              compiledChain: oldState.compiledChain,
                              chainResult: oldState.chainResult,
                              scriptFunctions: oldState.scriptFunctions,
                              chainExecutionResults: oldState.chainExecutionResults,
                              blocks: oldState.blocks,
                              inspected: oldState.inspected,
                              blockEdit: oldState.blockEdit,
                              scriptEditor: oldState.scriptEditor,
                              savedChainId: oldState.savedChainId,
                              requestValueCache: oldState.requestValueCache,
                              debugUIItems: oldState.debugUIItems,
                              connectionDrag: connectionDrag
                            };
                    }));
      })
  };
  var tmp$1 = state.scriptEditor.isOpen ? undefined : "none";
  if (tmp$1 !== undefined) {
    tmp.className = Caml_option.valFromOption(tmp$1);
  }
  var match$3 = state.blockEdit;
  var tmp$2;
  if (typeof match$3 === "number") {
    tmp$2 = null;
  } else {
    var editor = React.createElement(BlockEditor.make, {
          schema: state.schema,
          block: match$3._0,
          onClose: (function (param) {
              return Curry._1(setState, (function (oldState) {
                            return {
                                    diagram: oldState.diagram,
                                    card: oldState.card,
                                    schema: oldState.schema,
                                    chain: oldState.chain,
                                    compiledChain: oldState.compiledChain,
                                    chainResult: oldState.chainResult,
                                    scriptFunctions: oldState.scriptFunctions,
                                    chainExecutionResults: oldState.chainExecutionResults,
                                    blocks: oldState.blocks,
                                    inspected: oldState.inspected,
                                    blockEdit: /* Nothing */0,
                                    scriptEditor: oldState.scriptEditor,
                                    savedChainId: oldState.savedChainId,
                                    requestValueCache: oldState.requestValueCache,
                                    debugUIItems: oldState.debugUIItems,
                                    connectionDrag: oldState.connectionDrag
                                  };
                          }));
            }),
          onSave: (function (initial, superBlock) {
              var ast = Graphql.parse(superBlock.body);
              var initialAst = Caml_array.get(Graphql.parse(initial.body).definitions, 0);
              var newOperationDefinitionCount = Belt_Array.keep(ast.definitions, (function (definition) {
                      var match = definition.kind;
                      if (match === "FragmentDefinition") {
                        return false;
                      } else {
                        return true;
                      }
                    })).length;
              var guessedInitialBlock = {
                contents: undefined
              };
              var blocks = Belt_Array.mapWithIndex(ast.definitions, (function (_idx, definition) {
                      var match = definition.kind;
                      var kind = match === "FragmentDefinition" ? "fragment" : definition.operation;
                      var sameNameAsInitial = initialAst.name.value === definition.name.value;
                      var match$1 = initial.kind;
                      var sameOperationKindChanged = newOperationDefinitionCount !== 0 ? (
                          newOperationDefinitionCount !== 1 ? false : kind !== "fragment"
                        ) : (
                          match$1 >= 3 ? kind === "fragment" : false
                        );
                      var sameOperationAsInitial = sameNameAsInitial || sameOperationKindChanged ? true : false;
                      var services = Belt_Array.map(GraphQLUtils.gatherAllReferencedServices(schema, definition), (function (service) {
                              return service.slug;
                            }));
                      var blank = makeBlankBlock(undefined);
                      var title = Belt_Option.getWithDefault(definition.name.value, "Untitled");
                      var block_id = sameOperationAsInitial ? initial.id : Uuid.v4();
                      var block_description = blank.description;
                      var block_body = Graphql.print(definition);
                      var block_kind = kind === "mutation" ? /* Mutation */1 : (
                          kind === "fragment" ? /* Fragment */3 : (
                              kind === "subscription" ? /* Subscription */2 : /* Query */0
                            )
                        );
                      var block_contributedBy = blank.contributedBy;
                      var block = {
                        id: block_id,
                        title: title,
                        description: block_description,
                        body: block_body,
                        kind: block_kind,
                        contributedBy: block_contributedBy,
                        services: services
                      };
                      if (sameNameAsInitial || sameOperationKindChanged) {
                        guessedInitialBlock.contents = block;
                      }
                      return block;
                    }));
              try {
                return Curry._1(setState, (function (oldState) {
                              var newChain = Belt_Array.reduce(blocks, oldState.chain, (function (newChain, block) {
                                      var match = block.kind;
                                      if (match >= 3) {
                                        return {
                                                name: newChain.name,
                                                script: newChain.script,
                                                scriptDependencies: newChain.scriptDependencies,
                                                requests: newChain.requests,
                                                blocks: Belt_Array.concat(Belt_Array.keep(newChain.blocks, (function (existingBlock) {
                                                            return Caml_obj.caml_notequal(existingBlock.id, block.id);
                                                          })), [block])
                                              };
                                      }
                                      var isLikelyInitialBlock = Caml_obj.caml_equal(block, guessedInitialBlock.contents);
                                      var initialReq = isLikelyInitialBlock ? Belt_Array.getBy(newChain.requests, (function (request) {
                                                return Caml_obj.caml_equal(request.operation.id, initial.id);
                                              })) : undefined;
                                      var doc = Graphql.parse(block.body);
                                      var definition = Caml_array.get(doc.definitions, 0);
                                      var variableNames = GraphQLUtils.getOperationVariables(definition);
                                      var variableDependencies = Belt_Array.map(variableNames, (function (param) {
                                              var variableName = param[0];
                                              var existingVarDep = Belt_Option.flatMap(initialReq, (function (request) {
                                                      return Belt_Array.getBy(request.variableDependencies, (function (existingVariableDependency) {
                                                                    return existingVariableDependency.name === variableName;
                                                                  }));
                                                    }));
                                              var variableDep = {
                                                TAG: 1,
                                                _0: {
                                                  name: variableName,
                                                  value: {
                                                    TAG: 1,
                                                    _0: variableName,
                                                    [Symbol.for("name")]: "Variable"
                                                  }
                                                },
                                                [Symbol.for("name")]: "Direct"
                                              };
                                              return Belt_Option.getWithDefault(existingVarDep, {
                                                          name: variableName,
                                                          dependency: variableDep
                                                        });
                                            }));
                                      var newReq_id = block.title;
                                      var newReq_dependencyRequestIds = Belt_Option.mapWithDefault(initialReq, [], (function (req) {
                                              return req.dependencyRequestIds;
                                            }));
                                      var newReq = {
                                        id: newReq_id,
                                        variableDependencies: variableDependencies,
                                        operation: block,
                                        dependencyRequestIds: newReq_dependencyRequestIds
                                      };
                                      var names = Chain.requestScriptNames(newReq);
                                      var nameExistsInScript = Belt_Option.isSome(Caml_option.null_to_opt(newChain.script.match(new RegExp("export function " + names.functionName))));
                                      var newScript = nameExistsInScript ? newChain.script : newChain.script + ("\n\nexport function " + names.functionName + " (payload : " + names.inputTypeName + ") : " + names.returnTypeName + " {\n  return {}\n}");
                                      var newChain_name = newChain.name;
                                      var newChain_scriptDependencies = newChain.scriptDependencies;
                                      var newChain_requests = Belt_Array.concat(Belt_Array.keep(newChain.requests, (function (existingRequest) {
                                                  return existingRequest.id !== newReq_id;
                                                })), [newReq]);
                                      var newChain_blocks = Belt_Array.concat(Belt_Array.keep(newChain.blocks, (function (existingBlock) {
                                                  return Caml_obj.caml_notequal(existingBlock.id, block.id);
                                                })), [block]);
                                      var newChain$1 = {
                                        name: newChain_name,
                                        script: newScript,
                                        scriptDependencies: newChain_scriptDependencies,
                                        requests: newChain_requests,
                                        blocks: newChain_blocks
                                      };
                                      var match$1 = monacoTypelibForChain(schema, newChain$1);
                                      var importLine = match$1.importLine;
                                      var hasImport = Belt_Option.isSome(Caml_option.null_to_opt(newScript.match(new RegExp("import[\\s\\S.]+from[\\s\\S]+'oneGraphStudio';"))));
                                      var newScript$1 = hasImport ? newScript.replace(new RegExp("import[\\s\\S.]+from[\\s\\S]+'oneGraphStudio';"), importLine) : importLine + "\n\n" + newScript;
                                      return {
                                              name: newChain_name,
                                              script: newScript$1,
                                              scriptDependencies: newChain_scriptDependencies,
                                              requests: newChain_requests,
                                              blocks: newChain_blocks
                                            };
                                    }));
                              var newInitialBlock = Belt_Option.getWithDefault(Belt_Array.getBy(newChain.blocks, (function (block) {
                                          return Caml_obj.caml_equal(block.id, initial.id);
                                        })), Caml_array.get(blocks, 0));
                              var match = oldState.inspected;
                              var inspected;
                              switch (match.TAG | 0) {
                                case /* Nothing */0 :
                                    inspected = {
                                      TAG: 0,
                                      _0: newChain,
                                      [Symbol.for("name")]: "Nothing"
                                    };
                                    break;
                                case /* Block */1 :
                                    inspected = {
                                      TAG: 1,
                                      _0: newInitialBlock,
                                      [Symbol.for("name")]: "Block"
                                    };
                                    break;
                                case /* Request */2 :
                                    var request = match.request;
                                    var newRequest_id = request.id;
                                    var newRequest_variableDependencies = request.variableDependencies;
                                    var newRequest_dependencyRequestIds = request.dependencyRequestIds;
                                    var newRequest = {
                                      id: newRequest_id,
                                      variableDependencies: newRequest_variableDependencies,
                                      operation: newInitialBlock,
                                      dependencyRequestIds: newRequest_dependencyRequestIds
                                    };
                                    inspected = {
                                      TAG: 2,
                                      chain: newChain,
                                      request: newRequest,
                                      [Symbol.for("name")]: "Request"
                                    };
                                    break;
                                case /* RequestArgument */3 :
                                    var request$1 = match.request;
                                    var newRequest_id$1 = request$1.id;
                                    var newRequest_variableDependencies$1 = request$1.variableDependencies;
                                    var newRequest_dependencyRequestIds$1 = request$1.dependencyRequestIds;
                                    var newRequest$1 = {
                                      id: newRequest_id$1,
                                      variableDependencies: newRequest_variableDependencies$1,
                                      operation: newInitialBlock,
                                      dependencyRequestIds: newRequest_dependencyRequestIds$1
                                    };
                                    inspected = {
                                      TAG: 3,
                                      chain: newChain,
                                      request: newRequest$1,
                                      variableName: match.variableName,
                                      [Symbol.for("name")]: "RequestArgument"
                                    };
                                    break;
                                
                              }
                              var allBlocks = Belt_Array.concat(oldState.blocks, blocks);
                              var diagram = diagramFromChain$1(newChain);
                              return {
                                      diagram: diagram,
                                      card: oldState.card,
                                      schema: oldState.schema,
                                      chain: newChain,
                                      compiledChain: oldState.compiledChain,
                                      chainResult: oldState.chainResult,
                                      scriptFunctions: oldState.scriptFunctions,
                                      chainExecutionResults: oldState.chainExecutionResults,
                                      blocks: allBlocks,
                                      inspected: inspected,
                                      blockEdit: /* Nothing */0,
                                      scriptEditor: oldState.scriptEditor,
                                      savedChainId: oldState.savedChainId,
                                      requestValueCache: oldState.requestValueCache,
                                      debugUIItems: oldState.debugUIItems,
                                      connectionDrag: oldState.connectionDrag
                                    };
                            }));
              }
              catch (exn){
                return ;
              }
            })
        });
    tmp$2 = React.createElement(ChainEditor$Modal, {
          children: editor
        });
  }
  var conDrag = state.connectionDrag;
  var tmp$3;
  if (typeof conDrag === "number") {
    tmp$3 = null;
  } else {
    switch (conDrag.TAG | 0) {
      case /* StartedSource */0 :
          tmp$3 = React.createElement(ChainEditor$ConnectorLine, {
                source: conDrag.sourceDom,
                onDragEnd: (function (param) {
                    return Curry._1(setState, (function (oldState) {
                                  return {
                                          diagram: oldState.diagram,
                                          card: oldState.card,
                                          schema: oldState.schema,
                                          chain: oldState.chain,
                                          compiledChain: oldState.compiledChain,
                                          chainResult: oldState.chainResult,
                                          scriptFunctions: oldState.scriptFunctions,
                                          chainExecutionResults: oldState.chainExecutionResults,
                                          blocks: oldState.blocks,
                                          inspected: oldState.inspected,
                                          blockEdit: oldState.blockEdit,
                                          scriptEditor: oldState.scriptEditor,
                                          savedChainId: oldState.savedChainId,
                                          requestValueCache: oldState.requestValueCache,
                                          debugUIItems: oldState.debugUIItems,
                                          connectionDrag: /* Empty */0
                                        };
                                }));
                  }),
                invert: false
              });
          break;
      case /* StartedTarget */1 :
          tmp$3 = conDrag.target.TAG === /* Variable */0 ? React.createElement(ChainEditor$ConnectorLine, {
                  source: conDrag.sourceDom,
                  onDragEnd: (function (param) {
                      return Curry._1(setState, (function (oldState) {
                                    return {
                                            diagram: oldState.diagram,
                                            card: oldState.card,
                                            schema: oldState.schema,
                                            chain: oldState.chain,
                                            compiledChain: oldState.compiledChain,
                                            chainResult: oldState.chainResult,
                                            scriptFunctions: oldState.scriptFunctions,
                                            chainExecutionResults: oldState.chainExecutionResults,
                                            blocks: oldState.blocks,
                                            inspected: oldState.inspected,
                                            blockEdit: oldState.blockEdit,
                                            scriptEditor: oldState.scriptEditor,
                                            savedChainId: oldState.savedChainId,
                                            requestValueCache: oldState.requestValueCache,
                                            debugUIItems: oldState.debugUIItems,
                                            connectionDrag: /* Empty */0
                                          };
                                  }));
                    }),
                  invert: true
                }) : null;
          break;
      case /* Completed */2 :
          var match$4 = conDrag.target;
          var sourceRequest = conDrag.sourceRequest;
          if (match$4.TAG === /* Variable */0) {
            var match$5 = conDrag.windowPosition;
            var targetVariableDependency = match$4.variableDependency;
            var targetRequest = match$4.targetRequest;
            var chainFragmentsDoc = Belt_Array.keepMap(state.chain.blocks, (function (block) {
                      var match = block.kind;
                      if (match >= 3) {
                        return block.body;
                      }
                      
                    })).join("\n\n");
            var parsedOperation = Graphql.parse(sourceRequest.operation.body);
            var definition = Belt_Array.getExn(parsedOperation.definitions, 0);
            tmp$3 = React.createElement("div", {
                  className: "absolute",
                  style: {
                    left: String(match$5[0]) + "px",
                    top: String(match$5[1]) + "px",
                    width: "500px",
                    zIndex: "999"
                  }
                }, React.createElement("div", {
                      className: "m-2 p-2 bg-gray-600 rounded-sm text-gray-200"
                    }, React.createElement(Inspector.GraphQLPreview.make, {
                          requestId: sourceRequest.id,
                          schema: schema,
                          definition: definition,
                          fragmentDefinitions: GraphQLJs.Mock.gatherFragmentDefinitions({
                                operationDoc: chainFragmentsDoc
                              }),
                          onCopy: (function (path) {
                              var dataPath = Belt_Array.concat(["payload"], path);
                              return Curry._1(setState, (function (oldState) {
                                            var newDependency = {
                                              TAG: 2,
                                              _0: {
                                                name: targetVariableDependency.name,
                                                ifMissing: "SKIP",
                                                ifList: "FIRST",
                                                fromRequestId: sourceRequest.id,
                                                path: dataPath,
                                                functionFromScript: "TBD"
                                              },
                                              [Symbol.for("name")]: "GraphQLProbe"
                                            };
                                            var newRequests = Belt_Array.map(oldState.chain.requests, (function (request) {
                                                    if (targetRequest.id !== request.id) {
                                                      return request;
                                                    }
                                                    var varDeps = Belt_Array.map(request.variableDependencies, (function (varDep) {
                                                            if (varDep.name === targetVariableDependency.name) {
                                                              return {
                                                                      name: varDep.name,
                                                                      dependency: newDependency
                                                                    };
                                                            }
                                                            var argDep = varDep.dependency;
                                                            var dependency;
                                                            switch (argDep.TAG | 0) {
                                                              case /* ArgumentDependency */0 :
                                                                  var argDep$1 = argDep._0;
                                                                  var newArgDep_functionFromScript = argDep$1.functionFromScript;
                                                                  var newArgDep_maxRecur = argDep$1.maxRecur;
                                                                  var newArgDep_ifMissing = argDep$1.ifMissing;
                                                                  var newArgDep_ifList = argDep$1.ifList;
                                                                  var newArgDep_fromRequestIds = Utils.distinctStrings(Belt_Array.concat(argDep$1.fromRequestIds, [sourceRequest.id]));
                                                                  var newArgDep_name = argDep$1.name;
                                                                  var newArgDep = {
                                                                    functionFromScript: newArgDep_functionFromScript,
                                                                    maxRecur: newArgDep_maxRecur,
                                                                    ifMissing: newArgDep_ifMissing,
                                                                    ifList: newArgDep_ifList,
                                                                    fromRequestIds: newArgDep_fromRequestIds,
                                                                    name: newArgDep_name
                                                                  };
                                                                  dependency = {
                                                                    TAG: 0,
                                                                    _0: newArgDep,
                                                                    [Symbol.for("name")]: "ArgumentDependency"
                                                                  };
                                                                  break;
                                                              case /* Direct */1 :
                                                              case /* GraphQLProbe */2 :
                                                                  dependency = argDep;
                                                                  break;
                                                              
                                                            }
                                                            return {
                                                                    name: varDep.name,
                                                                    dependency: dependency
                                                                  };
                                                          }));
                                                    return {
                                                            id: request.id,
                                                            variableDependencies: varDeps,
                                                            operation: request.operation,
                                                            dependencyRequestIds: Utils.distinctStrings(Belt_Array.concat(request.dependencyRequestIds, [sourceRequest.id]))
                                                          };
                                                  }));
                                            var init = oldState.chain;
                                            var newChain_name = init.name;
                                            var newChain_script = init.script;
                                            var newChain_scriptDependencies = init.scriptDependencies;
                                            var newChain_blocks = init.blocks;
                                            var newChain = {
                                              name: newChain_name,
                                              script: newChain_script,
                                              scriptDependencies: newChain_scriptDependencies,
                                              requests: newRequests,
                                              blocks: newChain_blocks
                                            };
                                            var diagram = diagramFromChain$1(newChain);
                                            return {
                                                    diagram: diagram,
                                                    card: oldState.card,
                                                    schema: oldState.schema,
                                                    chain: newChain,
                                                    compiledChain: oldState.compiledChain,
                                                    chainResult: oldState.chainResult,
                                                    scriptFunctions: oldState.scriptFunctions,
                                                    chainExecutionResults: oldState.chainExecutionResults,
                                                    blocks: oldState.blocks,
                                                    inspected: oldState.inspected,
                                                    blockEdit: oldState.blockEdit,
                                                    scriptEditor: oldState.scriptEditor,
                                                    savedChainId: oldState.savedChainId,
                                                    requestValueCache: oldState.requestValueCache,
                                                    debugUIItems: oldState.debugUIItems,
                                                    connectionDrag: /* Empty */0
                                                  };
                                          }));
                            })
                        })));
          } else {
            var match$6 = conDrag.windowPosition;
            var scriptPosition = match$4.scriptPosition;
            var chainFragmentsDoc$1 = Belt_Array.keepMap(state.chain.blocks, (function (block) {
                      var match = block.kind;
                      if (match >= 3) {
                        return block.body;
                      }
                      
                    })).join("\n\n");
            var parsedOperation$1 = Graphql.parse(sourceRequest.operation.body);
            var definition$1 = Belt_Array.getExn(parsedOperation$1.definitions, 0);
            tmp$3 = React.createElement("div", {
                  className: "absolute",
                  style: {
                    left: String(match$6[0]) + "px",
                    maxHeight: "200px",
                    overflowY: "scroll",
                    top: String(match$6[1]) + "px",
                    width: "500px"
                  }
                }, React.createElement("div", {
                      className: "m-2 p-2 bg-gray-600 rounded-sm text-gray-200"
                    }, React.createElement(Inspector.GraphQLPreview.make, {
                          requestId: sourceRequest.id,
                          schema: schema,
                          definition: definition$1,
                          fragmentDefinitions: GraphQLJs.Mock.gatherFragmentDefinitions({
                                operationDoc: chainFragmentsDoc$1
                              }),
                          onCopy: (function (path) {
                              var dataPath = Belt_Array.concat(["payload"], path);
                              var re = new RegExp("\\[.+\\]", "g");
                              var binding = Caml_array.get(dataPath, dataPath.length - 1 | 0).replace(re, "");
                              return Curry._1(setState, (function (oldState) {
                                            var parsed;
                                            try {
                                              parsed = Caml_option.some(Typescript.createSourceFile("main.ts", oldState.chain.script, 99, true));
                                            }
                                            catch (exn){
                                              parsed = undefined;
                                            }
                                            var lineNumber = Belt_Option.map(parsed, (function (parsed) {
                                                    try {
                                                      var position = parsed.getPositionOfLineAndCharacter(scriptPosition.lineNumber - 1 | 0, scriptPosition.column - 1 | 0);
                                                      var parsedPosition = Belt_Option.getExn(TypeScript.findPositionOfFirstLineOfContainingFunctionForPosition(parsed, position));
                                                      var lineAndCharacter = parsed.getLineAndCharacterOfPosition(parsedPosition);
                                                      return lineAndCharacter.line + 1 | 0;
                                                    }
                                                    catch (raw_e){
                                                      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                                                      console.warn("Exn trying to find smart position", e);
                                                      return scriptPosition.lineNumber - 1 | 0;
                                                    }
                                                  }));
                                            var assignmentExpressionRange = Belt_Option.flatMap(parsed, (function (parsed) {
                                                    var position = parsed.getPositionOfLineAndCharacter(scriptPosition.lineNumber - 1 | 0, scriptPosition.column - 1 | 0);
                                                    return TypeScript.findContainingDeclaration(parsed, position);
                                                  }));
                                            var newScript;
                                            if (assignmentExpressionRange !== undefined) {
                                              var newBinding = assignmentExpressionRange.name + " = " + dataPath.join("?.");
                                              newScript = Utils.replaceRange(oldState.chain.script, assignmentExpressionRange.start + 1 | 0, assignmentExpressionRange.end, newBinding);
                                            } else if (lineNumber !== undefined) {
                                              var newBinding$1 = "\tlet " + binding + " = " + dataPath.join("?.");
                                              var temp = oldState.chain.script.split("\n");
                                              temp.splice(lineNumber, 0, newBinding$1);
                                              newScript = temp.join("\n");
                                            } else {
                                              newScript = oldState.chain.script;
                                            }
                                            var init = oldState.chain;
                                            var newChain_name = init.name;
                                            var newChain_scriptDependencies = init.scriptDependencies;
                                            var newChain_requests = init.requests;
                                            var newChain_blocks = init.blocks;
                                            var newChain = {
                                              name: newChain_name,
                                              script: newScript,
                                              scriptDependencies: newChain_scriptDependencies,
                                              requests: newChain_requests,
                                              blocks: newChain_blocks
                                            };
                                            return {
                                                    diagram: oldState.diagram,
                                                    card: oldState.card,
                                                    schema: oldState.schema,
                                                    chain: newChain,
                                                    compiledChain: oldState.compiledChain,
                                                    chainResult: oldState.chainResult,
                                                    scriptFunctions: oldState.scriptFunctions,
                                                    chainExecutionResults: oldState.chainExecutionResults,
                                                    blocks: oldState.blocks,
                                                    inspected: oldState.inspected,
                                                    blockEdit: oldState.blockEdit,
                                                    scriptEditor: oldState.scriptEditor,
                                                    savedChainId: oldState.savedChainId,
                                                    requestValueCache: oldState.requestValueCache,
                                                    debugUIItems: oldState.debugUIItems,
                                                    connectionDrag: /* Empty */0
                                                  };
                                          }));
                            })
                        })));
          }
          break;
      
    }
  }
  return React.createElement("div", undefined, React.createElement(ChainEditor$InspectedContextProvider, {
                  value: state.inspected,
                  children: React.createElement(ConnectionContext.Provider.make, {
                        value: state.connectionDrag,
                        children: null
                      }, React.createElement("div", {
                            className: "flex"
                          }, React.createElement("div", {
                                className: "w-1/6 h-screen 2xl:w-1/6 bg-gray-800"
                              }, blockSearch), React.createElement("div", {
                                className: "w-1/2"
                              }, React.createElement("div", {
                                    className: "h-1/2"
                                  }, Belt_Option.mapWithDefault(state.diagram, null, (function (diagram) {
                                          return React.createElement(ChainEditor$Diagram, {
                                                      setState: setState,
                                                      diagram: diagram,
                                                      chain: state.chain,
                                                      removeEdge: removeEdge,
                                                      removeRequest: removeRequest,
                                                      diagramFromChain: diagramFromChain$1
                                                    });
                                        }))), React.createElement("div", {
                                    className: "h-1/2"
                                  }, React.createElement("div", {
                                        className: "",
                                        onClick: (function (param) {
                                            return Curry._1(setState, (function (oldState) {
                                                          var init = oldState.scriptEditor;
                                                          return {
                                                                  diagram: oldState.diagram,
                                                                  card: oldState.card,
                                                                  schema: oldState.schema,
                                                                  chain: oldState.chain,
                                                                  compiledChain: oldState.compiledChain,
                                                                  chainResult: oldState.chainResult,
                                                                  scriptFunctions: oldState.scriptFunctions,
                                                                  chainExecutionResults: oldState.chainExecutionResults,
                                                                  blocks: oldState.blocks,
                                                                  inspected: oldState.inspected,
                                                                  blockEdit: oldState.blockEdit,
                                                                  scriptEditor: {
                                                                    isOpen: !oldState.scriptEditor.isOpen,
                                                                    editor: init.editor,
                                                                    monaco: init.monaco
                                                                  },
                                                                  savedChainId: oldState.savedChainId,
                                                                  requestValueCache: oldState.requestValueCache,
                                                                  debugUIItems: oldState.debugUIItems,
                                                                  connectionDrag: oldState.connectionDrag
                                                                };
                                                        }));
                                          })
                                      }, React.createElement("nav", undefined, React.createElement(Comps.Header.make, {
                                                style: {
                                                  backgroundColor: Comps.colors["gray-9"],
                                                  display: "flex",
                                                  marginRight: "0px",
                                                  marginLeft: "0px"
                                                },
                                                children: null
                                              }, React.createElement("div", {
                                                    className: "flex-grow"
                                                  }, "Chain JavaScript"), React.createElement("div", undefined, React.createElement("button", {
                                                        title: "Format code",
                                                        onClick: (function (param) {
                                                            return Belt_Option.forEach(state.scriptEditor.editor, (function (editor) {
                                                                          var script = editor.getValue();
                                                                          var newScript = Prettier.format(script, {
                                                                                parser: "babel",
                                                                                plugins: [ParserBabel],
                                                                                singleQuote: true
                                                                              });
                                                                          return Curry._1(setState, (function (oldState) {
                                                                                        var init = oldState.chain;
                                                                                        return {
                                                                                                diagram: oldState.diagram,
                                                                                                card: oldState.card,
                                                                                                schema: oldState.schema,
                                                                                                chain: {
                                                                                                  name: init.name,
                                                                                                  script: newScript,
                                                                                                  scriptDependencies: init.scriptDependencies,
                                                                                                  requests: init.requests,
                                                                                                  blocks: init.blocks
                                                                                                },
                                                                                                compiledChain: oldState.compiledChain,
                                                                                                chainResult: oldState.chainResult,
                                                                                                scriptFunctions: oldState.scriptFunctions,
                                                                                                chainExecutionResults: oldState.chainExecutionResults,
                                                                                                blocks: oldState.blocks,
                                                                                                inspected: oldState.inspected,
                                                                                                blockEdit: oldState.blockEdit,
                                                                                                scriptEditor: oldState.scriptEditor,
                                                                                                savedChainId: oldState.savedChainId,
                                                                                                requestValueCache: oldState.requestValueCache,
                                                                                                debugUIItems: oldState.debugUIItems,
                                                                                                connectionDrag: oldState.connectionDrag
                                                                                              };
                                                                                      }));
                                                                        }));
                                                          })
                                                      }, React.createElement(Icons.Prettier.Dark.make, {
                                                            width: "16px",
                                                            height: "16px"
                                                          })))))), React.createElement(ChainEditor$Script, tmp))), React.createElement("div", {
                                className: "w-1/3"
                              }, sidebar)), tmp$2, tmp$3)
                }));
}

var Main = {
  make: ChainEditor$Main
};

function ChainEditor(Props) {
  var schema = Props.schema;
  var initialChain = Props.initialChain;
  var config = Props.config;
  var oneGraphAuth = OneGraphAuth.create({
        appId: config.oneGraphAppId
      });
  return Belt_Option.getWithDefault(Belt_Option.map(oneGraphAuth, (function (oneGraphAuth) {
                    return React.createElement(ReactFlowRenderer.ReactFlowProvider, {
                                children: React.createElement(ChainEditor$Main, {
                                      schema: schema,
                                      initialChain: initialChain,
                                      config: config,
                                      oneGraphAuth: oneGraphAuth
                                    })
                              });
                  })), "Loading Chain Editor...");
}

var make$1 = ChainEditor;

export {
  SimpleTooltip ,
  FragmentNodeComponent ,
  makeBlankBlock ,
  compileChain ,
  BlockSearch ,
  InspectedContextProvider ,
  NodeLabel ,
  OperationNodeComponent ,
  emptyGraphLevel ,
  diagramFromChain ,
  backgroundStyle ,
  requestScriptTypeScriptSignature ,
  monacoTypelibForChain ,
  Script ,
  Modal ,
  ConnectorLine ,
  Diagram ,
  Main ,
  make$1 as make,
  
}
/* make Not a pure module */
